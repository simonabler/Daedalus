<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daedalus</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');
  :root {
    --bg: #0c0e14;
    --surface: #151821;
    --surface2: #1c2030;
    --surface3: #242a3a;
    --border: #2a3045;
    --border-light: #353d55;
    --text: #d8dce8;
    --text-dim: #7b839a;
    --text-faint: #555d74;
    --accent: #6e8eff;
    --accent-dim: #3d5099;
    --green: #4ade80;
    --green-dim: #1a3a2a;
    --red: #f87171;
    --red-dim: #3a1a1a;
    --yellow: #fbbf24;
    --yellow-dim: #3a2e10;
    --purple: #a78bfa;
    --cyan: #67e8f9;
    --font: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: var(--font); background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    display: flex; align-items: center; justify-content: space-between;
    position: relative;
    padding: 10px 20px; background: var(--surface); border-bottom: 1px solid var(--border);
  }
  header h1 { font-size: 14px; font-weight: 700; letter-spacing: 2px; color: var(--accent); position: relative; z-index: 1; }
  .header-center-image {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 390px;
    height: 30px;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid var(--border);
    background: var(--surface2);
    pointer-events: none;
    opacity: 0.95;
  }
  .header-center-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center center;
    display: block;
    filter: saturate(0.95) contrast(1.05);
  }
  .header-status { display: flex; align-items: center; gap: 12px; }
  .header-status { position: relative; z-index: 1; }
  .badge {
    padding: 3px 10px; border-radius: 10px; font-size: 10px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.8px;
  }
  .badge-idle { background: var(--surface3); color: var(--text-dim); }
  .badge-active { background: var(--green-dim); color: var(--green); animation: pulse 2s infinite; }
  .badge-error { background: var(--red-dim); color: var(--red); }
  .badge-done { background: var(--green-dim); color: var(--green); }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
  .progress-text { font-size: 11px; color: var(--text-dim); }

  /* â”€â”€ Main layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

  /* â”€â”€ Chat area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .chat { flex: 1; overflow-y: auto; padding: 16px 20px; display: flex; flex-direction: column; gap: 6px; }
  .chat::-webkit-scrollbar { width: 5px; }
  .chat::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* â”€â”€ Message types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .msg { max-width: 90%; border-radius: 8px; font-size: 12.5px; line-height: 1.6; }
  .msg-user {
    align-self: flex-end; background: var(--accent-dim); color: #fff;
    padding: 10px 14px; margin-top: 8px;
  }

  /* Status messages â€” always visible, prominent */
  .msg-status {
    align-self: flex-start; padding: 8px 14px;
    background: var(--surface2); border-left: 3px solid var(--accent);
    color: var(--text); font-weight: 500;
  }
  .msg-status.status-plan {
    border-left-color: var(--purple); background: #1a1530;
    white-space: pre-wrap; padding: 12px 16px;
  }
  .msg-status.status-verdict-approve { border-left-color: var(--green); }
  .msg-status.status-verdict-rework { border-left-color: var(--yellow); }
  .msg-status.status-verdict-pass { border-left-color: var(--green); }
  .msg-status.status-verdict-fail { border-left-color: var(--red); }
  .msg-status.status-commit { border-left-color: var(--cyan); }
  .msg-status.status-error { border-left-color: var(--red); background: var(--red-dim); color: var(--red); }
  .msg-status.status-complete { border-left-color: var(--green); background: var(--green-dim); color: var(--green); font-weight: 700; }

  /* Agent response bubble â€” visible reply from status/research nodes */
  .msg-response {
    align-self: flex-start; padding: 12px 16px;
    background: var(--surface2); border: 1px solid var(--border);
    border-left: 3px solid var(--purple); border-radius: 6px;
    color: var(--text); font-size: 13px; line-height: 1.7;
    white-space: pre-wrap; word-break: break-word;
    max-width: 95%; width: 100%;
  }
  .msg-response .resp-header {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 8px;
  }
  .msg-response .resp-body { color: var(--text); }

  /* Cost button colour states */
  .cost-btn { font-variant-numeric: tabular-nums; min-width: 90px; }
  .cost-btn.cost-soft  { background: var(--yellow-dim); color: var(--yellow); border-color: var(--yellow); }
  .cost-btn.cost-hard  { background: var(--red-dim);    color: var(--red);    border-color: var(--red);    animation: pulse 1s infinite; }

  /* Context window indicator button */
  .ctx-btn { font-variant-numeric: tabular-nums; min-width: 68px; }
  .ctx-btn.ctx-warn { background: var(--yellow-dim); color: var(--yellow); border-color: var(--yellow); }
  .ctx-btn.ctx-high { background: var(--red-dim);    color: var(--red);    border-color: var(--red); }

  /* Cost breakdown modal */
  .cost-modal {
    position: fixed; inset: 0; background: rgba(0,0,0,.6);
    display: flex; align-items: center; justify-content: center; z-index: 200;
  }
  .cost-modal-box {
    background: var(--surface1); border: 1px solid var(--border);
    border-radius: 10px; width: min(540px, 95vw); max-height: 80vh;
    display: flex; flex-direction: column; overflow: hidden;
  }
  .cost-modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 14px 18px; border-bottom: 1px solid var(--border);
    font-weight: 700; font-size: 14px; color: var(--text);
  }
  .cost-modal-header button {
    background: none; border: none; color: var(--text-dim);
    cursor: pointer; font-size: 16px;
  }
  .cost-modal-header button:hover { color: var(--text); }
  .cost-modal-body { padding: 18px; overflow-y: auto; font-size: 13px; }
  .cost-summary { margin-bottom: 16px; }
  .cost-summary .cost-total {
    font-size: 28px; font-weight: 700; color: var(--text);
    font-variant-numeric: tabular-nums;
  }
  .cost-summary .cost-meta { color: var(--text-dim); margin-top: 4px; }
  .cost-table { width: 100%; border-collapse: collapse; }
  .cost-table th {
    text-align: left; padding: 6px 10px; font-size: 11px; font-weight: 600;
    color: var(--text-dim); text-transform: uppercase; letter-spacing: .5px;
    border-bottom: 1px solid var(--border);
  }
  .cost-table td { padding: 7px 10px; border-bottom: 1px solid var(--surface3); }
  .cost-table tr:last-child td { border-bottom: none; }
  .cost-table .cost-num { text-align: right; font-variant-numeric: tabular-nums; }
  .cost-limit-warn  { color: var(--yellow); font-weight: 600; margin-top: 12px; }
  .cost-limit-error { color: var(--red);    font-weight: 600; margin-top: 12px; }

  /* Streaming token blocks â€” live typewriter output */
  .msg-stream {
    align-self: flex-start; padding: 10px 14px;
    background: var(--surface); border: 1px solid var(--border);
    border-left: 3px solid var(--accent); border-radius: 6px;
    color: var(--text); font-size: 12.5px; line-height: 1.6;
    white-space: pre-wrap; word-break: break-word;
    max-width: 95%; width: 100%;
  }
  .msg-stream .stream-header {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 6px; font-size: 11px; color: var(--text-dim);
  }
  .msg-stream .stream-body { color: var(--text); }
  .stream-cursor {
    display: inline-block; width: 2px; height: 1em;
    background: var(--accent); margin-left: 1px;
    vertical-align: text-bottom;
    animation: blink 0.8s step-end infinite;
  }
  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
  .msg-stream.stream-done { border-left-color: var(--border); }
  .msg-stream.stream-done .stream-cursor { display: none; }

  /* Collapsible detail blocks â€” for agent internals */
  .msg-detail {
    align-self: flex-start; max-width: 95%; width: 100%;
  }
  .msg-detail details {
    background: var(--surface); border: 1px solid var(--border); border-radius: 6px;
    overflow: hidden;
  }
  .msg-detail summary {
    padding: 7px 12px; font-size: 11.5px; color: var(--text-dim); cursor: pointer;
    display: flex; align-items: center; gap: 8px; user-select: none;
    transition: background 0.15s;
  }
  .msg-detail summary:hover { background: var(--surface2); }
  .msg-detail summary::marker { content: ''; }
  .msg-detail summary .arrow {
    font-size: 9px; transition: transform 0.2s; color: var(--text-faint);
  }
  .msg-detail details[open] summary .arrow { transform: rotate(90deg); }
  .msg-detail .agent-tag {
    font-size: 9px; font-weight: 700; padding: 1px 6px; border-radius: 3px;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .tag-planner { background: #2a2050; color: var(--purple); }
  .tag-coder_a { background: #1a2a40; color: #60a5fa; }
  .tag-coder_b { background: #1a3030; color: #34d399; }
  .tag-reviewer_a { background: #2a1a40; color: #c084fc; }
  .tag-reviewer_b { background: #1a3a30; color: #6ee7b7; }
  .tag-documenter { background: #2d2532; color: #f9a8d4; }
  .tag-tester { background: #3a2a10; color: var(--yellow); }
  .tag-system { background: var(--surface3); color: var(--text-dim); }

  .msg-detail .detail-body {
    padding: 10px 14px; font-size: 11px; line-height: 1.5; color: var(--text-dim);
    white-space: pre-wrap; word-break: break-word; max-height: 400px; overflow-y: auto;
    border-top: 1px solid var(--border);
  }
  .msg-detail .detail-body::-webkit-scrollbar { width: 4px; }
  .msg-detail .detail-body::-webkit-scrollbar-thumb { background: var(--border); }

  /* Tool call sub-items inside details */
  .tool-item {
    margin: 4px 0; padding: 4px 8px; background: var(--surface2);
    border-radius: 4px; font-size: 10.5px;
  }
  .tool-item .tool-name { color: var(--cyan); font-weight: 600; }
  .tool-item .tool-args { color: var(--text-faint); }

  /* â”€â”€ Input row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .input-row {
    display: flex; gap: 8px; padding: 12px 20px;
    background: var(--surface); border-top: 1px solid var(--border);
  }
  .input-row input {
    flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 6px;
    background: var(--surface2); color: var(--text); font-family: var(--font);
    font-size: 12.5px; outline: none;
  }
  .input-row input:focus { border-color: var(--accent); }
  .input-row button {
    padding: 10px 24px; background: var(--accent); color: #fff; border: none;
    border-radius: 6px; font-family: var(--font); font-size: 12px; font-weight: 700;
    cursor: pointer; letter-spacing: 0.5px; transition: opacity 0.15s;
  }
  .input-row button:hover { opacity: 0.85; }

  /* â”€â”€ Approval Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .approval-panel {
    margin: 8px 0; border-radius: 8px; overflow: hidden;
    border: 1px solid var(--yellow); background: #1e1a08;
    animation: slide-in 0.25s ease;
  }
  /* Avoid opacity-based entry animation on interactive panels.
     E2E runners often pause/disable animations, which can freeze elements at opacity:0. */
  @keyframes slide-in { from { transform: translateY(6px); } to { transform: none; } }

  .approval-header {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 16px; background: #2a2308; border-bottom: 1px solid #3a3010;
  }
  .approval-header .approval-icon { font-size: 18px; }
  .approval-header .approval-title {
    flex: 1; font-size: 13px; font-weight: 700; color: var(--yellow); letter-spacing: 0.5px;
  }
  .approval-header .approval-summary { font-size: 11px; color: var(--text-dim); }

  .approval-triggers {
    padding: 8px 16px; display: flex; flex-wrap: wrap; gap: 6px;
    border-bottom: 1px solid #2a2210;
  }
  .trigger-pill {
    padding: 3px 9px; border-radius: 12px; font-size: 10px; font-weight: 600;
    letter-spacing: 0.4px; text-transform: uppercase;
  }
  .trigger-commit   { background: #1a2a40; color: #60a5fa; }
  .trigger-large    { background: #2a1f00; color: var(--yellow); }
  .trigger-deletion { background: #3a1010; color: var(--red); }
  .trigger-ci       { background: #1a1a40; color: var(--purple); }

  .approval-files {
    padding: 8px 16px; border-bottom: 1px solid #2a2210;
  }
  .approval-files .files-label {
    font-size: 10px; color: var(--text-faint); text-transform: uppercase; letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  .approval-files .file-list {
    display: flex; flex-direction: column; gap: 2px;
  }
  .approval-files .file-entry {
    font-size: 11px; color: var(--text-dim); padding: 1px 0;
  }
  .approval-files .file-entry::before { content: "â€¢ "; color: var(--text-faint); }

  .approval-diff {
    border-bottom: 1px solid #2a2210;
  }
  .approval-diff details summary {
    padding: 8px 16px; font-size: 11px; color: var(--text-faint); cursor: pointer;
    user-select: none; list-style: none; display: flex; align-items: center; gap: 6px;
  }
  .approval-diff details summary::marker { content: ''; }
  .approval-diff details summary .diff-arrow { font-size: 9px; transition: transform 0.2s; }
  .approval-diff details[open] summary .diff-arrow { transform: rotate(90deg); }
  .approval-diff .diff-body {
    padding: 10px 16px; font-size: 10.5px; line-height: 1.5; color: var(--text-dim);
    white-space: pre; overflow-x: auto; max-height: 300px; overflow-y: auto;
    border-top: 1px solid #2a2210; tab-size: 4;
  }
  .approval-diff .diff-body::-webkit-scrollbar { width: 4px; height: 4px; }
  .approval-diff .diff-body::-webkit-scrollbar-thumb { background: var(--border); }
  /* diff syntax colouring */
  .diff-add  { color: #4ade80; }
  .diff-del  { color: #f87171; }
  .diff-hunk { color: #67e8f9; }
  .diff-meta { color: var(--text-faint); }

  .approval-actions {
    display: flex; gap: 10px; padding: 12px 16px;
  }
  .btn-approve, .btn-reject {
    flex: 1; padding: 10px 0; border: none; border-radius: 6px;
    font-family: var(--font); font-size: 12px; font-weight: 700;
    letter-spacing: 0.8px; cursor: pointer; transition: opacity 0.15s, transform 0.1s;
  }
  .btn-approve { background: #166534; color: #4ade80; }
  .btn-approve:hover { background: #15803d; }
  .btn-reject  { background: #7f1d1d; color: #f87171; }
  .btn-reject:hover  { background: #991b1b; }
  .btn-approve:active, .btn-reject:active { transform: scale(0.97); }
  .btn-approve:disabled, .btn-reject:disabled {
    opacity: 0.4; cursor: default; transform: none;
  }

  /* â”€â”€ Coder Question Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .question-panel {
    margin: 8px 0; border-radius: 8px; overflow: hidden;
    border: 1px solid var(--purple); background: #130e1e;
    animation: slide-in 0.25s ease;
  }
  .question-header {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 16px; background: #1a1228; border-bottom: 1px solid #2a1a40;
  }
  .question-header .q-icon { font-size: 18px; }
  .question-header .q-title {
    flex: 1; font-size: 13px; font-weight: 700; color: var(--purple); letter-spacing: 0.5px;
  }  .question-header .q-agent {
    font-size: 10px; padding: 2px 8px; border-radius: 8px;
    background: #2a1a40; color: #c084fc; font-weight: 700; text-transform: uppercase;
  }
  .question-header .q-urgency-badge {
    font-size: 10px; padding: 2px 7px; border-radius: 8px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.3px;
  }
  .urgency-blocking { background: #3a1010; color: #f87171; }
  .urgency-advisory { background: #2a1e00; color: #fbbf24; }
  .question-default-hint {
    margin-top: 6px; font-size: 11px; color: var(--text-faint); font-style: italic;
    padding: 5px 10px; background: var(--surface2); border-radius: 4px;
    border-left: 2px solid #fbbf24;
  }
  .btn-skip {
    align-self: flex-end; padding: 8px 14px; background: transparent;
    border: 1px solid var(--border-light); color: var(--text-dim); border-radius: 5px;
    font-family: var(--font); font-size: 11px; font-weight: 700; cursor: pointer;
    transition: opacity 0.15s, border-color 0.15s;
  }
  .btn-skip:hover { border-color: #fbbf24; color: #fbbf24; }
  .btn-skip:disabled { opacity: 0.4; cursor: default; }
  .question-body { padding: 14px 16px; border-bottom: 1px solid #2a1a40; }
  .question-text {
    font-size: 13px; color: var(--text); line-height: 1.6; margin-bottom: 0;
  }
  .question-context {
    margin-top: 8px; font-size: 11px; color: var(--text-dim); line-height: 1.5;
    padding: 8px 12px; background: var(--surface2); border-radius: 4px;
    border-left: 2px solid var(--purple);
  }
  .question-options {
    padding: 10px 16px; display: flex; flex-direction: column; gap: 6px;
    border-bottom: 1px solid #2a1a40;
  }
  .question-options .opt-label {
    font-size: 10px; color: var(--text-faint); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;
  }
  .btn-option {
    padding: 8px 14px; background: #1e1430; border: 1px solid #3a1a55;
    border-radius: 5px; color: #c084fc; font-family: var(--font); font-size: 11.5px;
    text-align: left; cursor: pointer; transition: background 0.15s, border-color 0.15s;
  }
  .btn-option:hover { background: #2a1a45; border-color: var(--purple); }
  .question-freetext {
    padding: 10px 16px; display: flex; gap: 8px;
  }
  .question-freetext .ft-label {
    font-size: 10px; color: var(--text-faint); text-transform: uppercase;
    letter-spacing: 0.5px; margin-bottom: 4px;
  }
  .question-freetext-inner { flex: 1; display: flex; flex-direction: column; gap: 6px; }
  .question-freetext input {
    padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;
    background: var(--surface2); color: var(--text); font-family: var(--font);
    font-size: 12px; outline: none;
  }
  .question-freetext input:focus { border-color: var(--purple); }
  .btn-answer {
    align-self: flex-end; padding: 8px 20px; background: var(--purple);
    color: #fff; border: none; border-radius: 5px; font-family: var(--font);
    font-size: 12px; font-weight: 700; cursor: pointer; transition: opacity 0.15s;
  }
  .btn-answer:hover { opacity: 0.85; }
  .btn-answer:disabled { opacity: 0.4; cursor: default; }

  /* â”€â”€ Intel button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .intel-btn {
    padding: 4px 12px; border-radius: 6px; border: 1px solid var(--border-light);
    background: var(--surface2); color: var(--accent); font-family: var(--font);
    font-size: 11px; font-weight: 700; cursor: pointer; transition: background 0.15s;
    letter-spacing: 0.5px;
  }
  .intel-btn:hover { background: var(--surface3); }
  .intel-btn.active { background: var(--accent-dim); border-color: var(--accent); }

  /* â”€â”€ Plan Approval Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .plan-approval-panel {
    margin: 8px 0; border-radius: 8px; overflow: visible;
    border: 1px solid #60a5fa; background: #0a1628;
    animation: slide-in 0.25s ease;
  }
  .plan-approval-header {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 16px; background: #0f1e38; border-bottom: 1px solid #1e3a6e;
  }
  .plan-approval-header .pa-icon { font-size: 18px; }
  .plan-approval-header .pa-title {
    flex: 1; font-size: 13px; font-weight: 700; color: #60a5fa; letter-spacing: 0.5px;
  }
  .plan-approval-header .pa-count {
    font-size: 11px; color: var(--text-dim);
    background: #1e3a6e; padding: 2px 8px; border-radius: 8px;
  }
  .plan-approval-items {
    padding: 10px 16px; border-bottom: 1px solid #1e3a6e;
    display: flex; flex-direction: column; gap: 4px;
  }
  .plan-item-row {
    display: flex; align-items: baseline; gap: 8px;
    font-size: 12px; color: var(--text-dim); padding: 2px 0;
  }
  .plan-item-num { color: var(--text-faint); font-size: 11px; min-width: 18px; }
  .plan-item-type {
    padding: 1px 6px; border-radius: 4px; font-size: 10px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.3px; flex-shrink: 0;
  }
  .type-coding     { background: #1a2a40; color: #60a5fa; }
  .type-testing    { background: #1a2a1a; color: #4ade80; }
  .type-documentation { background: #2a1a2a; color: #c084fc; }
  .type-ops        { background: #2a1a0a; color: #fb923c; }
  .plan-item-desc  { flex: 1; }
  .plan-item-agent { font-size: 10px; color: var(--text-faint); flex-shrink: 0; }
  .plan-approval-feedback {
    padding: 10px 16px; border-bottom: 1px solid #1e3a6e;
    display: none; flex-direction: column; gap: 6px;
  }
  .plan-approval-feedback.visible { display: flex; }
  .plan-approval-feedback label {
    font-size: 10px; color: var(--text-faint); text-transform: uppercase; letter-spacing: 0.5px;
  }
  .plan-approval-feedback textarea {
    background: var(--surface2); border: 1px solid #1e3a6e; border-radius: 5px;
    color: var(--text); font-family: var(--font); font-size: 12px; padding: 8px 10px;
    resize: vertical; min-height: 60px; outline: none;
  }
  .plan-approval-feedback textarea:focus { border-color: #60a5fa; }
  .plan-approval-actions {
    display: flex; gap: 8px; padding: 12px 16px; flex-wrap: wrap;
  }
  .btn-plan-approve {
    flex: 2; padding: 9px 0; border: none; border-radius: 6px;
    font-family: var(--font); font-size: 12px; font-weight: 700;
    letter-spacing: 0.6px; cursor: pointer; transition: opacity 0.15s;
    background: #166534; color: #4ade80;
  }
  .btn-plan-approve:hover { background: #15803d; }
  .btn-plan-revise {
    flex: 2; padding: 9px 0; border: 1px solid #1e3a6e; border-radius: 6px;
    font-family: var(--font); font-size: 12px; font-weight: 700;
    letter-spacing: 0.6px; cursor: pointer; transition: opacity 0.15s;
    background: transparent; color: #60a5fa;
  }
  .btn-plan-revise:hover { background: #0f1e38; }
  .btn-plan-cancel {
    flex: 1; padding: 9px 0; border: none; border-radius: 6px;
    font-family: var(--font); font-size: 12px; font-weight: 700;
    letter-spacing: 0.6px; cursor: pointer; transition: opacity 0.15s;
    background: #7f1d1d; color: #f87171;
  }
  .btn-plan-cancel:hover { background: #991b1b; }
  .btn-plan-approve:disabled, .btn-plan-revise:disabled, .btn-plan-cancel:disabled {
    opacity: 0.4; cursor: default;
  }

  /* â”€â”€ Intelligence Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .intel-panel {
    position: fixed; top: 0; right: 0; bottom: 0; width: 380px; max-width: 100vw;
    background: var(--surface); border-left: 1px solid var(--border);
    display: flex; flex-direction: column; z-index: 100; overflow: hidden;
    box-shadow: -4px 0 24px rgba(0,0,0,0.4);
    animation: slide-in-right 0.2s ease;
  }
  @keyframes slide-in-right {
    from { transform: translateX(100%); opacity: 0; }
    to   { transform: translateX(0);   opacity: 1; }
  }
  .intel-header {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 14px; background: var(--surface2);
    border-bottom: 1px solid var(--border); flex-shrink: 0;
  }
  .intel-title { flex: 1; font-size: 11px; font-weight: 700; color: var(--accent); letter-spacing: 1.5px; }
  .intel-cache-badge {
    font-size: 9px; padding: 2px 7px; border-radius: 8px;
    background: var(--surface3); color: var(--text-dim); font-weight: 700;
  }
  .intel-refresh, .intel-close {
    background: none; border: none; color: var(--text-dim); cursor: pointer;
    font-size: 14px; padding: 2px 5px; border-radius: 4px; transition: color 0.15s;
    font-family: var(--font);
  }
  .intel-refresh:hover, .intel-close:hover { color: var(--text); }
  .intel-body { flex: 1; overflow-y: auto; padding: 12px 14px; display: flex; flex-direction: column; gap: 12px; }
  .intel-body::-webkit-scrollbar { width: 4px; }
  .intel-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .intel-loading { color: var(--text-dim); font-size: 12px; padding: 20px 0; text-align: center; }
  .intel-empty { color: var(--text-faint); font-size: 11px; text-align: center; padding: 40px 0; }

  /* Intel sections */
  .intel-section { border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
  .intel-section-hdr {
    display: flex; align-items: center; gap: 8px;
    padding: 7px 12px; background: var(--surface2);
    font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
    cursor: pointer; user-select: none;
  }
  .intel-section-hdr:hover { background: var(--surface3); }
  .intel-section-hdr .s-icon { font-size: 13px; }
  .intel-section-hdr .s-title { flex: 1; }
  .intel-section-hdr .s-count {
    padding: 1px 7px; border-radius: 8px; font-size: 9px; font-weight: 800;
  }
  .s-count-error { background: var(--red-dim); color: var(--red); }
  .s-count-warning { background: var(--yellow-dim); color: var(--yellow); }
  .s-count-ok { background: var(--green-dim); color: var(--green); }
  .s-count-info { background: var(--surface3); color: var(--text-dim); }
  .intel-section-body { padding: 8px 0; }
  .intel-section.collapsed .intel-section-body { display: none; }

  /* Intel rows */
  .intel-row {
    display: flex; align-items: flex-start; gap: 8px;
    padding: 5px 12px; font-size: 11.5px; line-height: 1.5; border-bottom: 1px solid var(--border);
  }
  .intel-row:last-child { border-bottom: none; }
  .intel-row .r-sev {
    font-size: 9px; font-weight: 800; padding: 1px 5px; border-radius: 3px; flex-shrink: 0; margin-top: 2px;
  }
  .r-sev-error { background: var(--red-dim); color: var(--red); }
  .r-sev-warning { background: var(--yellow-dim); color: var(--yellow); }
  .r-sev-info { background: var(--surface3); color: var(--text-dim); }
  .intel-row .r-text { flex: 1; color: var(--text); }
  .intel-row .r-loc { color: var(--text-faint); font-size: 10px; }

  /* Summary cards */
  .intel-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 8px 12px; }
  .intel-card {
    border-radius: 5px; padding: 8px 10px; background: var(--surface2);
    border: 1px solid var(--border);
  }
  .intel-card .c-label { font-size: 9px; color: var(--text-faint); text-transform: uppercase; letter-spacing: 0.8px; }
  .intel-card .c-value { font-size: 20px; font-weight: 700; color: var(--text); margin-top: 2px; }
  .intel-card .c-sub { font-size: 9px; color: var(--text-dim); margin-top: 1px; }
  .intel-card.c-err .c-value { color: var(--red); }
  .intel-card.c-warn .c-value { color: var(--yellow); }
  .intel-card.c-ok .c-value { color: var(--green); }
  .intel-card.c-info .c-value { color: var(--accent); }

  /* â”€â”€ Issue Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .issue-card {
    margin: 8px 0; border-radius: 8px; overflow: hidden;
    border: 1px solid #34d399; background: #071a12;
    animation: slide-in 0.25s ease;
  }
  .issue-card-header {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px; background: #0a2218; border-bottom: 1px solid #1a3a28;
  }
  .issue-card-header .ic-icon { font-size: 16px; }
  .issue-card-header .ic-number {
    font-size: 12px; font-weight: 700; color: #34d399;
    background: #0f2e1e; padding: 2px 8px; border-radius: 8px;
  }
  .issue-card-header .ic-title {
    flex: 1; font-size: 12.5px; font-weight: 600; color: var(--text);
  }
  .issue-card-body {
    padding: 10px 14px; font-size: 11px; color: var(--text-dim); line-height: 1.5;
    display: flex; gap: 20px; flex-wrap: wrap;
  }
  .issue-card-body .ic-repo { color: var(--text-faint); }
  .issue-card-body .ic-url a {
    color: #34d399; text-decoration: none;
  }
  .issue-card-body .ic-url a:hover { text-decoration: underline; }

  /* â”€â”€ PR/MR Result Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .pr-banner {
    margin: 8px 0; border-radius: 8px; overflow: hidden;
    border: 1px solid var(--cyan); background: #071a20;
    animation: slide-in 0.25s ease;
  }
  .pr-banner-inner {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 16px;
  }
  .pr-banner-icon { font-size: 20px; }
  .pr-banner-text { flex: 1; }
  .pr-banner-label {
    font-size: 11px; font-weight: 700; color: var(--cyan);
    text-transform: uppercase; letter-spacing: 0.8px;
  }
  .pr-banner-title {
    font-size: 13px; font-weight: 600; color: var(--text); margin-top: 2px;
  }
  .pr-banner-url a {
    color: var(--cyan); text-decoration: none; font-size: 11.5px;
    word-break: break-all;
  }
  .pr-banner-url a:hover { text-decoration: underline; }
  .pr-banner-number {
    font-size: 24px; font-weight: 700; color: var(--cyan);
    font-variant-numeric: tabular-nums;
  }

  /* â”€â”€ Approval PR hint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .approval-pr-hint {
    padding: 8px 16px; border-bottom: 1px solid #2a2210;
    display: flex; align-items: center; gap: 8px;
    font-size: 11px; color: var(--cyan); background: #071a20;
  }
  .approval-pr-hint .ph-branch {
    font-size: 10px; padding: 1px 6px; border-radius: 4px;
    background: #0a2a30; color: #67e8f9; font-family: var(--font);
  }

  /* Cycle paths */
  .cycle-path {
    padding: 5px 12px; font-size: 11px; color: var(--red);
    border-bottom: 1px solid var(--border); word-break: break-all;
  }
  .cycle-path:last-child { border-bottom: none; }

  /* Coupling rows */
  .coupling-row {
    display: flex; align-items: center; gap: 8px; padding: 5px 12px;
    font-size: 11px; border-bottom: 1px solid var(--border);
  }
  .coupling-row:last-child { border-bottom: none; }
  .coupling-bar-bg { flex: 1; height: 4px; background: var(--surface3); border-radius: 2px; }
  .coupling-bar { height: 4px; border-radius: 2px; background: var(--accent); }
  .coupling-score { font-size: 10px; color: var(--text-dim); width: 32px; text-align: right; }

  @media (prefers-reduced-motion: reduce) {
    .approval-panel,
    .question-panel,
    .plan-approval-panel,
    .issue-card,
    .pr-banner,
    .intel-panel {
      animation: none !important;
    }
  }
</style>
</head>
<body>
<header>
  <h1>âš™ Daedalus</h1>
  <div class="header-center-image" aria-hidden="true">
    <img src="/images/daedalus.png" alt="">
  </div>
  <div class="header-status">
    <span class="progress-text" id="progressText">â€”</span>
    <span id="repoRef" style="display:none;font-size:10px;color:var(--text-faint);padding:2px 8px;background:var(--surface2);border-radius:6px;border:1px solid var(--border)"></span>
    <span id="issueBadge" style="display:none;font-size:10px;font-weight:700;padding:2px 8px;background:#071a12;border:1px solid #34d399;border-radius:6px;color:#34d399"></span>
    <span class="badge badge-idle" id="badge">IDLE</span>
    <button class="intel-btn ctx-btn" id="ctxBtn" title="Context window usage" style="display:none">ğŸ“Š 0%</button>
    <button class="intel-btn cost-btn" id="costBtn" onclick="toggleCostModal()" title="Token budget &amp; cost breakdown">ğŸ’° $0.0000</button>
    <button class="intel-btn" id="intelBtn" onclick="toggleIntel()" title="Code Intelligence Dashboard">ğŸ§  Intel</button>
  </div>
</header>

<div class="main">
  <div class="chat" id="chat">
    <div class="msg msg-status">Ready. Enter a coding task to begin.</div>
  </div>
  <div class="input-row">
    <input type="text" id="taskInput" placeholder="Describe a coding taskâ€¦" autocomplete="off" />
    <button onclick="sendTask()">SEND</button>
  </div>
</div>

<!-- Cost Breakdown Modal -->
<div class="cost-modal" id="costModal" style="display:none">
  <div class="cost-modal-box">
    <div class="cost-modal-header">
      <span>ğŸ’° Token Budget &amp; Cost</span>
      <button onclick="toggleCostModal()" title="Close">âœ•</button>
    </div>
    <div class="cost-modal-body" id="costModalBody">
      <p style="color:var(--text-dim);text-align:center">No data yet.</p>
    </div>
  </div>
</div>

<!-- Intelligence Dashboard Panel -->
<div class="intel-panel" id="intelPanel" style="display:none">
  <div class="intel-header">
    <span class="intel-title">ğŸ§  CODE INTELLIGENCE</span>
    <span class="intel-cache-badge" id="intelCacheBadge"></span>
    <button class="intel-refresh" onclick="loadIntelligence()" title="Refresh">â†»</button>
    <button class="intel-close" onclick="toggleIntel()" title="Close">âœ•</button>
  </div>
  <div class="intel-body" id="intelBody">
    <div class="intel-loading">Loading intelligence dataâ€¦</div>
  </div>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('taskInput');
const badge = document.getElementById('badge');
const progressText = document.getElementById('progressText');

// Track open detail blocks to group tool calls
let currentDetailBlock = null;
let currentDetailTools = null;
// Track open streaming block (live token output)
let currentStreamBlock = null;
let currentStreamAgent = null;
let currentStreamBody = null;

// â”€â”€ Agent tag colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TAG_CLASS = {
  planner: 'tag-planner', coder_a: 'tag-coder_a', coder_b: 'tag-coder_b',
  documenter: 'tag-documenter',
  reviewer_a: 'tag-reviewer_a', reviewer_b: 'tag-reviewer_b',
  tester: 'tag-tester', system: 'tag-system',
};

const AGENT_NAMES = {
  planner: 'PLANNER', coder_a: 'CODER A Â· Claude', coder_b: 'CODER B Â· GPT-5.2',
  documenter: 'DOCUMENTER',
  reviewer_a: 'REVIEWER A Â· Claude', reviewer_b: 'REVIEWER B Â· GPT-5.2',
  tester: 'TESTER', system: 'SYSTEM',
};

// â”€â”€ Scroll helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scrollBottom() {
  requestAnimationFrame(() => { chat.scrollTop = chat.scrollHeight; });
}

// â”€â”€ Add a prominent status message â”€â”€â”€â”€â”€â”€â”€
function addStatus(text, extraClass = '') {
  currentDetailBlock = null;
  const div = document.createElement('div');
  div.className = `msg msg-status ${extraClass}`;
  div.textContent = text;
  chat.appendChild(div);
  scrollBottom();
}

// â”€â”€ Add a user message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addUser(text) {
  currentDetailBlock = null;
  const div = document.createElement('div');
  div.className = 'msg msg-user';
  div.textContent = text;
  chat.appendChild(div);
  scrollBottom();
}

// â”€â”€ Context window indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateContextIndicator(eventData) {
  const meta = eventData.metadata || {};
  const fraction = meta.fraction ?? 0;
  const pct = Math.round(fraction * 100);

  const btn = document.getElementById('ctxBtn');
  if (!btn) return;
  btn.style.display = '';
  btn.textContent = `ğŸ“Š ${pct}%`;

  btn.classList.remove('ctx-warn', 'ctx-high');
  if (fraction >= 0.75)      btn.classList.add('ctx-high');
  else if (fraction >= 0.50) btn.classList.add('ctx-warn');

  // Update tooltip with details
  const estTok = (meta.estimated_tokens ?? 0).toLocaleString();
  const limTok = (meta.model_limit ?? 0).toLocaleString();
  btn.title = `Context: ${pct}% (${estTok} / ${limTok} tokens)${meta.compressed ? ' â€” compressed' : ''}`;
}

// â”€â”€ Token budget / cost tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _totalCostUsd = 0;
let _costData = null;  // latest budget summary from events or /api/status

function updateCostIndicator(eventData) {
  const meta = eventData.metadata || {};
  _totalCostUsd = meta.total_cost_usd ?? _totalCostUsd;
  _costData = meta;

  const btn = document.getElementById('costBtn');
  if (!btn) return;
  btn.style.display = '';
  btn.textContent = `ğŸ’° $${_totalCostUsd.toFixed(4)}`;

  // Colour state (soft / hard limit)
  btn.classList.remove('cost-soft', 'cost-hard');
  if (meta.hard_limit_hit) btn.classList.add('cost-hard');
  else if (meta.soft_limit_hit) btn.classList.add('cost-soft');
}

function toggleCostModal() {
  const modal = document.getElementById('costModal');
  if (modal.style.display === 'none') {
    renderCostModal();
    modal.style.display = 'flex';
  } else {
    modal.style.display = 'none';
  }
}

function renderCostModal() {
  const body = document.getElementById('costModalBody');
  if (!_costData && _totalCostUsd === 0) {
    body.innerHTML = '<p style="color:var(--text-dim);text-align:center;padding:24px 0">No token usage recorded yet.<br><span style="font-size:11px">Costs appear here after the first LLM call.</span></p>';
    return;
  }

  const total     = _totalCostUsd;
  const totalTok  = (_costData?.total_tokens) ?? 0;
  const softHit   = _costData?.soft_limit_hit;
  const hardHit   = _costData?.hard_limit_hit;
  const softLim   = _costData?.soft_limit_usd ?? 0;
  const hardLim   = _costData?.hard_limit_usd ?? 0;
  const perAgent  = _costData?.per_agent ?? {};

  let html = `
    <div class="cost-summary">
      <div class="cost-total">$${total.toFixed(4)}</div>
      <div class="cost-meta">${totalTok.toLocaleString()} tokens total</div>
      ${softHit ? `<div class="cost-limit-warn">âš ï¸ Soft limit hit ($${softLim.toFixed(2)})</div>` : ''}
      ${hardHit ? `<div class="cost-limit-error">âŒ Hard limit hit ($${hardLim.toFixed(2)})</div>` : ''}
    </div>
    <table class="cost-table">
      <thead>
        <tr>
          <th>Agent</th>
          <th class="cost-num">Calls</th>
          <th class="cost-num">Prompt</th>
          <th class="cost-num">Completion</th>
          <th class="cost-num">Cost (USD)</th>
        </tr>
      </thead>
      <tbody>`;

  const agents = Object.keys(perAgent).sort();
  for (const ag of agents) {
    const d = perAgent[ag];
    html += `
      <tr>
        <td><span class="agent-tag ${TAG_CLASS[ag] || 'tag-system'}">${AGENT_NAMES[ag] || ag}</span></td>
        <td class="cost-num">${d.calls ?? 0}</td>
        <td class="cost-num">${(d.prompt_tokens ?? 0).toLocaleString()}</td>
        <td class="cost-num">${(d.completion_tokens ?? 0).toLocaleString()}</td>
        <td class="cost-num">$${(d.cost_usd ?? 0).toFixed(4)}</td>
      </tr>`;
  }

  if (agents.length === 0) {
    html += '<tr><td colspan="5" style="text-align:center;color:var(--text-dim)">No calls recorded yet.</td></tr>';
  }

  html += `</tbody></table>`;
  body.innerHTML = html;
}

// Close cost modal on backdrop click
document.addEventListener('click', e => {
  const modal = document.getElementById('costModal');
  if (modal && e.target === modal) modal.style.display = 'none';
});

// â”€â”€ Add a visible agent response bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addResponse(agent, body) {
  finaliseStream();
  currentDetailBlock = null;
  currentDetailTools = null;

  const block = document.createElement('div');
  block.className = 'msg msg-response';

  const hdr = document.createElement('div');
  hdr.className = 'resp-header';

  const tag = document.createElement('span');
  tag.className = `agent-tag ${TAG_CLASS[agent] || 'tag-system'}`;
  tag.textContent = AGENT_NAMES[agent] || agent;

  hdr.appendChild(tag);
  block.appendChild(hdr);

  const bodyDiv = document.createElement('div');
  bodyDiv.className = 'resp-body';
  bodyDiv.textContent = body;
  block.appendChild(bodyDiv);

  chat.appendChild(block);
  scrollBottom();
}

// â”€â”€ Append a streaming token to the live stream block â”€â”€â”€
function appendToken(agent, token) {
  // Create a new stream block if agent changed or none exists
  if (!currentStreamBlock || currentStreamAgent !== agent) {
    // Finalise any previous stream block
    if (currentStreamBlock) {
      currentStreamBlock.classList.add('stream-done');
    }

    const block = document.createElement('div');
    block.className = 'msg msg-stream';

    const hdr = document.createElement('div');
    hdr.className = 'stream-header';

    const tag = document.createElement('span');
    tag.className = `agent-tag ${TAG_CLASS[agent] || 'tag-system'}`;
    tag.textContent = AGENT_NAMES[agent] || agent;

    const label = document.createElement('span');
    label.textContent = 'â— streamingâ€¦';

    hdr.appendChild(tag);
    hdr.appendChild(label);
    block.appendChild(hdr);

    const body = document.createElement('div');
    body.className = 'stream-body';

    const cursor = document.createElement('span');
    cursor.className = 'stream-cursor';
    body.appendChild(cursor);

    block.appendChild(body);
    chat.appendChild(block);

    currentStreamBlock = block;
    currentStreamAgent = agent;
    currentStreamBody = body;
    currentDetailBlock = null;
    currentDetailTools = null;
  }

  // Insert token before the cursor
  const cursor = currentStreamBody.querySelector('.stream-cursor');
  const textNode = document.createTextNode(token);
  currentStreamBody.insertBefore(textNode, cursor);
  scrollBottom();
}

// â”€â”€ Finalise any open streaming block â”€â”€â”€â”€
function finaliseStream() {
  if (currentStreamBlock) {
    currentStreamBlock.classList.add('stream-done');
    currentStreamBlock = null;
    currentStreamAgent = null;
    currentStreamBody = null;
  }
}

// â”€â”€ Add a collapsible detail block â”€â”€â”€â”€â”€â”€â”€
function addDetail(agent, title, body) {
  const wrapper = document.createElement('div');
  wrapper.className = 'msg msg-detail';

  const details = document.createElement('details');
  const summary = document.createElement('summary');

  const arrow = document.createElement('span');
  arrow.className = 'arrow';
  arrow.textContent = 'â–¶';

  const tag = document.createElement('span');
  tag.className = `agent-tag ${TAG_CLASS[agent] || 'tag-system'}`;
  tag.textContent = AGENT_NAMES[agent] || agent;

  const titleSpan = document.createElement('span');
  titleSpan.textContent = title;

  summary.appendChild(arrow);
  summary.appendChild(tag);
  summary.appendChild(titleSpan);
  details.appendChild(summary);

  if (body) {
    const bodyDiv = document.createElement('div');
    bodyDiv.className = 'detail-body';
    bodyDiv.textContent = body;
    details.appendChild(bodyDiv);
  }

  wrapper.appendChild(details);
  chat.appendChild(wrapper);
  currentDetailBlock = details;
  currentDetailTools = null;
  scrollBottom();
  return details;
}

// â”€â”€ Add tool call inside current detail block â”€â”€
function addToolCall(agent, toolName, args, result) {
  // If we have an open detail block from the same agent, append tool info
  if (!currentDetailBlock) {
    addDetail(agent, `ğŸ”§ Tool calls`, '');
  }

  // Find or create tool list inside the detail body
  let bodyDiv = currentDetailBlock.querySelector('.detail-body');
  if (!bodyDiv) {
    bodyDiv = document.createElement('div');
    bodyDiv.className = 'detail-body';
    currentDetailBlock.appendChild(bodyDiv);
  }

  const item = document.createElement('div');
  item.className = 'tool-item';
  item.innerHTML = `<span class="tool-name">âš¡ ${esc(toolName)}</span>`;
  if (args) item.innerHTML += ` <span class="tool-args">${esc(args)}</span>`;
  bodyDiv.appendChild(item);

  if (result) {
    const res = document.createElement('div');
    res.style.cssText = 'padding:2px 8px; font-size:10px; color:var(--text-faint); max-height:120px; overflow-y:auto; margin-bottom:4px;';
    res.textContent = result.substring(0, 500) + (result.length > 500 ? 'â€¦' : '');
    bodyDiv.appendChild(res);
  }
  scrollBottom();
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// â”€â”€ Diff syntax highlighting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDiff(raw) {
  return raw.split('\n').map(line => {
    const e = esc(line);
    if (line.startsWith('+') && !line.startsWith('+++')) return `<span class="diff-add">${e}</span>`;
    if (line.startsWith('-') && !line.startsWith('---')) return `<span class="diff-del">${e}</span>`;
    if (line.startsWith('@@'))  return `<span class="diff-hunk">${e}</span>`;
    if (line.startsWith('diff') || line.startsWith('index') || line.startsWith('---') || line.startsWith('+++'))
      return `<span class="diff-meta">${e}</span>`;
    return e;
  }).join('\n');
}

// â”€â”€ Build and insert the approval panel â”€â”€â”€â”€â”€â”€
let _approvalPanel = null;

function showApprovalPanel(meta) {
  currentDetailBlock = null;

  // Remove any existing panel first (shouldn't happen, but be safe)
  if (_approvalPanel) _approvalPanel.remove();

  const panel = document.createElement('div');
  panel.className = 'approval-panel';

  // Trigger pills
  const triggerPillsHTML = (meta.triggers || []).map(t => {
    const cls = t.type === 'commit'       ? 'trigger-commit'
              : t.type === 'large_diff'   ? 'trigger-large'
              : t.type === 'file_deletion'? 'trigger-deletion'
              : t.type === 'ci_config_change' ? 'trigger-ci' : 'trigger-commit';
    return `<span class="trigger-pill ${cls}">${esc(t.reason)}</span>`;
  }).join('');

  // File list (max 20 shown)
  const files = meta.files || [];
  const fileListHTML = files.slice(0, 20).map(f =>
    `<div class="file-entry">${esc(f)}</div>`
  ).join('') + (files.length > 20
    ? `<div class="file-entry" style="color:var(--text-faint)">â€¦ and ${files.length - 20} more</div>`
    : '');

  // Diff preview
  const diffRaw = meta.diff_preview || '';
  const diffSection = diffRaw ? `
    <div class="approval-diff">
      <details>
        <summary>
          <span class="diff-arrow">â–¶</span>
          Show diff preview (${diffRaw.split('\n').length} lines)
        </summary>
        <div class="diff-body">${renderDiff(diffRaw)}</div>
      </details>
    </div>` : '';

  // PR hint
  const prHint = meta.will_create_pr ? `
    <div class="approval-pr-hint">
      ğŸ”— A PR/MR will be opened automatically after push
      ${meta.branch ? `<span class="ph-branch">${esc(meta.branch)}</span>` : ''}
    </div>` : '';

  panel.innerHTML = `
    <div class="approval-header">
      <span class="approval-icon">âš ï¸</span>
      <span class="approval-title">HUMAN APPROVAL REQUIRED</span>
      <span class="approval-summary">${esc(meta.summary || '')}</span>
    </div>
    <div class="approval-triggers">${triggerPillsHTML}</div>
    <div class="approval-files">
      <div class="files-label">Changed files</div>
      <div class="file-list">${fileListHTML || '<div class="file-entry" style="color:var(--text-faint)">No staged files detected</div>'}</div>
    </div>
    ${diffSection}
    ${prHint}
    <div class="approval-actions">
      <button class="btn-approve" id="btnApprove">âœ… APPROVE &amp; PUSH${meta.will_create_pr ? ' + OPEN PR' : ''}</button>
      <button class="btn-reject"  id="btnReject">âŒ REJECT</button>
    </div>`;

  chat.appendChild(panel);
  _approvalPanel = panel;
  scrollBottom();

  // Wire buttons
  panel.querySelector('#btnApprove').addEventListener('click', () => submitApproval(true, panel));
  panel.querySelector('#btnReject').addEventListener('click',  () => submitApproval(false, panel));
}

async function submitApproval(approved, panel) {
  const btnApprove = panel.querySelector('#btnApprove');
  const btnReject  = panel.querySelector('#btnReject');
  btnApprove.disabled = true;
  btnReject.disabled  = true;
  btnApprove.textContent = approved ? 'â³ Approvingâ€¦' : 'âœ… APPROVE';
  btnReject.textContent  = approved ? 'âŒ REJECT' : 'â³ Rejectingâ€¦';

  try {
    const res = await fetch('/api/approve', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ approved }),
    });
    const data = await res.json();
    if (data.error) {
      addStatus(`âŒ Approval error: ${data.error}`, 'status-error');
      btnApprove.disabled = false;
      btnReject.disabled  = false;
      btnApprove.textContent = 'âœ… APPROVE';
      btnReject.textContent  = 'âŒ REJECT';
      return;
    }
    // Replace panel with confirmation
    const confirmEl = document.createElement('div');
    confirmEl.className = `msg msg-status ${approved ? 'status-verdict-approve' : 'status-error'}`;
    confirmEl.textContent = approved
      ? 'âœ… Approved â€” workflow continuing to commitâ€¦'
      : 'âŒ Rejected â€” workflow stopped.';
    panel.replaceWith(confirmEl);
    _approvalPanel = null;
    scrollBottom();
  } catch (err) {
    addStatus(`âŒ Network error: ${err}`, 'status-error');
    btnApprove.disabled = false;
    btnReject.disabled  = false;
    btnApprove.textContent = 'âœ… APPROVE';
    btnReject.textContent  = 'âŒ REJECT';
  }
}

// â”€â”€ Plan Approval Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _planApprovalPanel = null;
let _planApprovalRestoreTimer = null;
let _planApprovalRestoreInFlight = false;

function hasPlanApprovalPanel() {
  if (_planApprovalPanel && !_planApprovalPanel.isConnected) _planApprovalPanel = null;
  return !!_planApprovalPanel;
}

function _planMetaFromStatus(data) {
  const items = Array.isArray(data?.pending_plan_items) ? data.pending_plan_items : [];
  return {
    items,
    items_count: items.length,
    plan_summary: data?.plan_summary || '',
  };
}

function scheduleRestorePlanApprovalPanel(reason = 'unknown') {
  if (hasPlanApprovalPanel() || _planApprovalRestoreInFlight || _planApprovalRestoreTimer) return;
  _planApprovalRestoreTimer = setTimeout(() => {
    _planApprovalRestoreTimer = null;
    restorePlanApprovalPanel(reason);
  }, 500);
}

async function restorePlanApprovalPanel(reason = 'unknown') {
  if (hasPlanApprovalPanel() || _planApprovalRestoreInFlight) return;
  _planApprovalRestoreInFlight = true;
  try {
    const res = await fetch('/api/status');
    const data = await res.json();
    if (data?.phase === 'waiting_for_plan_approval' && !hasPlanApprovalPanel()) {
      console.debug('Restoring plan approval panel from /api/status', { reason, items: (data.pending_plan_items || []).length });
      showPlanApprovalPanel(_planMetaFromStatus(data));
    }
  } catch (err) {
    console.warn('restorePlanApprovalPanel failed', { reason, err });
  } finally {
    _planApprovalRestoreInFlight = false;
  }
}

function showPlanApprovalPanel(meta) {
  let panel = null;
  try {
    if (_planApprovalPanel) _planApprovalPanel.remove();

    const items    = meta.items || [];
    const count    = meta.items_count || items.length;

  const itemsHTML = items.map((item, idx) => {
    const typeClass = 'type-' + String(item.task_type || 'coding').toLowerCase().replace(/[^a-z]/g, '');
    const agent     = item.assigned_agent ? `â†’ ${esc(item.assigned_agent)}` : '';
    return `<div class="plan-item-row">
      <span class="plan-item-num">${idx + 1}.</span>
      <span class="plan-item-type ${typeClass}">${esc(String(item.task_type || 'coding'))}</span>
      <span class="plan-item-desc">${esc(String(item.description || ''))}</span>
      <span class="plan-item-agent">${agent}</span>
    </div>`;
  }).join('');

  panel = document.createElement('div');
  panel.className = 'plan-approval-panel';
  panel.innerHTML = `
    <div class="plan-approval-header">
      <span class="pa-icon">ğŸ“‹</span>
      <span class="pa-title">PLAN READY â€” YOUR APPROVAL REQUIRED</span>
      <span class="pa-count">${count} item${count !== 1 ? 's' : ''}</span>
    </div>
    <div class="plan-approval-items">${itemsHTML || '<div style="color:var(--text-faint);font-size:12px">(no items)</div>'}</div>
    <div class="plan-approval-feedback" id="paFeedback">
      <label>Revision note for the planner</label>
      <textarea id="paFeedbackText" placeholder="Describe what to change or addâ€¦"></textarea>
    </div>
    <div class="plan-approval-actions">
      <button class="btn-plan-approve" id="btnPlanApprove">âœ… Approve &amp; Start Coding</button>
      <button class="btn-plan-revise"  id="btnPlanRevise">âœï¸ Approve with Note</button>
      <button class="btn-plan-cancel"  id="btnPlanCancel">âŒ Cancel</button>
    </div>`;

  chat.appendChild(panel);
  _planApprovalPanel = panel;
  scrollBottom();

  const btnApprove = panel.querySelector('#btnPlanApprove');
  const btnRevise  = panel.querySelector('#btnPlanRevise');
  const btnCancel  = panel.querySelector('#btnPlanCancel');
  const feedback   = panel.querySelector('#paFeedback');
  const fbText     = panel.querySelector('#paFeedbackText');

  let reviseMode = false;

  btnRevise.addEventListener('click', () => {
    if (!reviseMode) {
      reviseMode = true;
      feedback.classList.add('visible');
      btnRevise.textContent = 'ğŸ“¤ Send Revision Request';
      fbText.focus();
    } else {
      // Submit with feedback
      submitPlanApproval(true, fbText.value.trim(), panel);
    }
  });

  btnApprove.addEventListener('click', () => submitPlanApproval(true, '', panel));
  btnCancel.addEventListener('click',  () => submitPlanApproval(false, '', panel));
  } catch (err) {
    if (panel && panel.isConnected) panel.remove();
    if (_planApprovalPanel === panel) _planApprovalPanel = null;
    console.error('showPlanApprovalPanel failed', { meta, err });
  }
}

async function submitPlanApproval(approved, feedback, panel) {
  const btns = panel.querySelectorAll('button');
  btns.forEach(b => b.disabled = true);

  try {
    const res = await fetch('/api/plan-approve', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({approved, feedback: feedback || ''}),
    });
    const data = await res.json();

    const msg = document.createElement('div');
    if (!approved) {
      msg.className = 'msg msg-status status-error';
      msg.textContent = 'âŒ Task cancelled by user.';
    } else if (feedback) {
      msg.className = 'msg msg-status';
      msg.textContent = 'âœï¸ Revision requested â€” planner will update the planâ€¦';
    } else {
      msg.className = 'msg msg-status status-verdict-approve';
      msg.textContent = 'âœ… Plan approved â€” ğŸš€ coding started!';
    }
    panel.replaceWith(msg);
    _planApprovalPanel = null;
    scrollBottom();
  } catch (err) {
    btns.forEach(b => b.disabled = false);
    console.error('plan-approve error', err);
  }
}

// â”€â”€ Coder Question Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _questionPanel = null;

function showQuestionPanel(meta) {
  currentDetailBlock = null;
  if (_questionPanel) _questionPanel.remove();

  const panel = document.createElement('div');
  panel.className = 'question-panel';

  const agentLabel  = meta.asked_by === 'coder_a' ? 'CODER A Â· Claude' : 'CODER B Â· GPT';
  const urgency     = meta.urgency || 'blocking';
  const isAdvisory  = urgency === 'advisory';
  const urgencyText = isAdvisory ? 'ğŸŸ¡ ADVISORY' : 'ğŸ”´ BLOCKING';
  const urgencyCls  = isAdvisory ? 'urgency-advisory' : 'urgency-blocking';
  const default_    = meta.default_if_skipped || '';

  const contextHtml = meta.context
    ? `<div class="question-context">${esc(meta.context)}</div>` : '';

  const defaultHintHtml = (isAdvisory && default_)
    ? `<div class="question-default-hint">If skipped: ${esc(default_)}</div>` : '';

  const options    = meta.options || [];
  const optionsHtml = options.length
    ? `<div class="question-options">
        <div class="opt-label">Quick answers</div>
        ${options.map((o, i) => `<button class="btn-option" data-idx="${i}">${esc(o)}</button>`).join('')}
      </div>` : '';

  const skipBtnHtml = isAdvisory
    ? `<button class="btn-skip" id="btnSkip" title="Skip question and proceed with stated default">âš¡ Skip â€” use default</button>` : '';

  panel.innerHTML = `
    <div class="question-header">
      <span class="q-icon">ğŸ¤”</span>
      <span class="q-title">CODER IS ASKING</span>
      <span class="q-urgency-badge ${urgencyCls}">${urgencyText}</span>
      <span class="q-agent">${esc(agentLabel)}</span>
    </div>
    <div class="question-body">
      <div class="question-text">${esc(meta.question)}</div>
      ${contextHtml}
      ${defaultHintHtml}
    </div>
    ${optionsHtml}
    <div class="question-freetext">
      <div class="question-freetext-inner">
        <div class="ft-label">Custom answer</div>
        <input type="text" id="answerInput" placeholder="Type your answerâ€¦" autocomplete="off" />
        <div style="display:flex;gap:8px;justify-content:flex-end">
          ${skipBtnHtml}
          <button class="btn-answer" id="btnAnswer">SEND</button>
        </div>
      </div>
    </div>`;

  chat.appendChild(panel);
  _questionPanel = panel;
  scrollBottom();

  // Option buttons
  panel.querySelectorAll('.btn-option').forEach(btn => {
    btn.addEventListener('click', () => submitAnswer(btn.textContent.trim(), panel));
  });

  // Skip button (advisory only)
  const skipBtn = panel.querySelector('#btnSkip');
  if (skipBtn) {
    skipBtn.addEventListener('click', () => submitAnswer('__skip__', panel));
  }

  // Free-text send
  panel.querySelector('#btnAnswer').addEventListener('click', () => {
    const val = panel.querySelector('#answerInput').value.trim();
    if (val) submitAnswer(val, panel);
  });
  panel.querySelector('#answerInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const val = panel.querySelector('#answerInput').value.trim();
      if (val) submitAnswer(val, panel);
    }
  });
}

async function submitAnswer(answer, panel) {
  const btn = panel.querySelector('#btnAnswer');
  const input = panel.querySelector('#answerInput');
  if (btn) btn.disabled = true;
  if (input) input.disabled = true;
  panel.querySelectorAll('.btn-option').forEach(b => b.disabled = true);

  try {
    const res = await fetch('/api/answer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ answer }),
    });
    const data = await res.json();
    if (data.error) {
      addStatus(`âŒ Answer error: ${data.error}`, 'status-error');
      if (btn) btn.disabled = false;
      if (input) input.disabled = false;
      panel.querySelectorAll('.btn-option').forEach(b => b.disabled = false);
      return;
    }
    const confirmEl = document.createElement('div');
    confirmEl.className = 'msg msg-status status-verdict-approve';
    confirmEl.textContent = `ğŸ’¬ Answer sent: "${answer}" â€” coder will continue.`;
    panel.replaceWith(confirmEl);
    _questionPanel = null;
    scrollBottom();
  } catch (err) {
    addStatus(`âŒ Network error: ${err}`, 'status-error');
    if (btn) btn.disabled = false;
    if (input) input.disabled = false;
    panel.querySelectorAll('.btn-option').forEach(b => b.disabled = false);
  }
}

// â”€â”€ Handle incoming events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleEvent(evt) {
  const { category, agent, title, detail, metadata } = evt;
  const seq = Number(evt?.seq || 0);
  if (seq) {
    if (_lastEventSeq && seq <= _lastEventSeq) {
      console.warn('WS event sequence non-monotonic', { last: _lastEventSeq, current: seq, category, title });
    } else if (_lastEventSeq && seq > _lastEventSeq + 1) {
      console.warn('WS event sequence gap detected', { last: _lastEventSeq, current: seq, category, title });
    }
    if (seq > _lastEventSeq) _lastEventSeq = seq;
  }

  switch (category) {
    case 'status':
      // Special: issue loaded â†’ show issue card
      if (title === 'issue_loaded' && metadata) {
        showIssueCard(metadata);
        updateHeader({ phase: metadata.phase || 'planning' });
        break;
      }
      // Always show as prominent status line
      let cls = '';
      if (metadata?.phase === 'complete') cls = 'status-complete';
      else if (title.includes('âŒ') || title.includes('Error')) cls = 'status-error';
      addStatus(title, cls);
      if (metadata) {
        updateHeader({
          phase: metadata.phase || 'idle',
          completed: metadata.items_done,
          total: metadata.items_total,
          branch: metadata.branch || '',
        });
        // Sync token budget from status metadata if present
        if (metadata.token_budget) {
          _costData = metadata.token_budget;
          _totalCostUsd = metadata.token_budget.total_cost_usd ?? _totalCostUsd;
          const btn = document.getElementById('costBtn');
          if (btn && _totalCostUsd > 0) {
            btn.style.display = '';
            btn.textContent = `ğŸ’° $${_totalCostUsd.toFixed(4)}`;
          }
        }
        // Detect intelligence_complete event metadata
        if (metadata.type === 'intelligence_complete') {
          _onIntelligenceComplete();
        }
        if (metadata.phase === 'waiting_for_plan_approval' && !hasPlanApprovalPanel()) {
          if (metadata.needs_plan_approval && Array.isArray(metadata.pending_plan_items)) {
            showPlanApprovalPanel(_planMetaFromStatus(metadata));
          } else {
            scheduleRestorePlanApprovalPanel('status_event');
          }
        }
      }
      break;

    case 'plan':
      // Show plan prominently
      addStatus(title + '\n' + detail, 'status-plan');
      break;

    case 'verdict':
      // Show verdicts prominently
      const v = (metadata?.verdict || '').toLowerCase();
      const vcls = v === 'approve' ? 'status-verdict-approve'
                 : v === 'rework' ? 'status-verdict-rework'
                 : v === 'pass' ? 'status-verdict-pass'
                 : v === 'fail' ? 'status-verdict-fail' : '';
      addStatus(title, vcls);
      // Collapsible detail for the review content
      if (detail) addDetail(agent, `${AGENT_NAMES[agent] || agent} review details`, detail);
      break;

    case 'commit':
      addStatus(title, 'status-commit');
      // If this commit event carries a PR/MR result, show the PR banner
      if (metadata && metadata.pr_url) {
        showPrBanner(metadata);
      }
      break;

    case 'error':
      addStatus(title + (detail ? ': ' + detail : ''), 'status-error');
      break;

    case 'approval_needed':
      showApprovalPanel(metadata || {});
      break;

    case 'plan_approval':
      showPlanApprovalPanel(metadata || {});
      if (!hasPlanApprovalPanel()) scheduleRestorePlanApprovalPanel('plan_approval_event');
      break;

    case 'approval_done':
      // Panel was already replaced by submitApproval(); this just ensures
      // any late-joining client (reconnect) also sees the outcome.
      if (_approvalPanel) {
        const approved = metadata?.approved;
        const confirmEl = document.createElement('div');
        confirmEl.className = `msg msg-status ${approved ? 'status-verdict-approve' : 'status-error'}`;
        confirmEl.textContent = approved
          ? 'âœ… Approved â€” workflow continuing to commitâ€¦'
          : 'âŒ Rejected â€” workflow stopped.';
        _approvalPanel.replaceWith(confirmEl);
        _approvalPanel = null;
        scrollBottom();
      }
      break;

    case 'coder_question':
      showQuestionPanel(metadata || {});
      break;

    case 'coder_answer':
      // Panel replaced by submitAnswer(); handle reconnect case
      if (_questionPanel) {
        const answerText = metadata?.answer || '';
        const confirmEl = document.createElement('div');
        confirmEl.className = 'msg msg-status status-verdict-approve';
        confirmEl.textContent = `ğŸ’¬ Answer sent: "${answerText}" â€” coder will continue.`;
        _questionPanel.replaceWith(confirmEl);
        _questionPanel = null;
        scrollBottom();
      }
      break;

    case 'node_start':
      // Collapsible: "â–¶ Coding started â€” Working on: ..."
      addDetail(agent, title + (detail ? ` â€” ${detail}` : ''), '');
      break;

    case 'node_end':
      // Collapsible end summary
      if (detail) addDetail(agent, title, detail);
      break;

    case 'agent_token':
      // Streaming token chunk â€” append to live block
      appendToken(agent, title);
      break;

    case 'agent_response':
      // Visible conversational reply from status/research nodes
      addResponse(agent, detail);
      break;

    case 'token_usage':
      // Update cost indicator in header
      updateCostIndicator(evt);
      break;

    case 'context_usage':
      // Update context window indicator in header
      updateContextIndicator(evt);
      break;

    case 'agent_think':
      // Finalise any open stream before showing thinking block
      finaliseStream();
      // Collapsible: agent is thinking
      addDetail(agent, title, detail || '(processingâ€¦)');
      break;

    case 'agent_result':
      // Finalise streaming block, then show result in collapsible
      finaliseStream();
      addDetail(agent, title, detail);
      break;

    case 'tool_call':
      // Streaming pauses during tool execution â€” finalise the stream block
      finaliseStream();
      addToolCall(agent, detail ? title.replace(`ğŸ”§ ${agent} â†’ `, '') : title, detail, '');
      break;

    case 'tool_result':
      // Append result to the current tool block
      addToolCall(agent, title.replace('ğŸ“ ', '').replace(' returned', ''), '', detail);
      break;

    default:
      // Unknown category â€” show as detail
      addDetail(agent, title, detail);
  }
}

// â”€â”€ Update header status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Issue Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showIssueCard(meta) {
  const number  = meta.issue_number || meta.issue_id || '?';
  const title   = meta.issue_title  || meta.title     || '';
  const repo    = meta.repo_ref     || '';
  const url     = meta.issue_url    || '';
  const platform = meta.platform    || '';
  const icon    = platform === 'gitlab' ? 'ğŸ¦Š' : 'ğŸ™';

  const card = document.createElement('div');
  card.className = 'issue-card';
  card.innerHTML = `
    <div class="issue-card-header">
      <span class="ic-icon">${icon}</span>
      <span class="ic-number">#${esc(String(number))}</span>
      <span class="ic-title">${esc(title)}</span>
    </div>
    <div class="issue-card-body">
      ${repo ? `<span class="ic-repo">ğŸ“ ${esc(repo)}</span>` : ''}
      ${url  ? `<span class="ic-url"><a href="${esc(url)}" target="_blank" rel="noopener">ğŸ”— View issue</a></span>` : ''}
      <span style="color:var(--text-faint)">ğŸ”„ Starting analysisâ€¦</span>
    </div>`;

  chat.appendChild(card);
  scrollBottom();

  // Update header badge
  const badge = document.getElementById('issueBadge');
  if (badge) {
    badge.textContent = `${icon} #${number}`;
    badge.style.display = '';
    badge.title = title;
  }
}

// â”€â”€ PR/MR Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _prBanner = null;

function showPrBanner(meta) {
  // Don't show duplicates
  if (_prBanner) return;

  const url      = meta.pr_url    || '';
  const number   = meta.pr_number || meta.number || '?';
  const platform = meta.platform  || 'github';
  const branch   = meta.branch    || '';
  const label    = platform === 'gitlab' ? 'MR' : 'PR';

  const banner = document.createElement('div');
  banner.className = 'pr-banner';
  banner.innerHTML = `
    <div class="pr-banner-inner">
      <span class="pr-banner-icon">ğŸ”—</span>
      <div class="pr-banner-text">
        <div class="pr-banner-label">${label} OPENED AUTOMATICALLY</div>
        <div class="pr-banner-title">${label} #${esc(String(number))}${branch ? ` Â· <span style="color:var(--text-dim);font-size:11px">${esc(branch)}</span>` : ''}</div>
        ${url ? `<div class="pr-banner-url"><a href="${esc(url)}" target="_blank" rel="noopener">${esc(url)}</a></div>` : ''}
      </div>
      <div class="pr-banner-number">#${esc(String(number))}</div>
    </div>`;

  chat.appendChild(banner);
  _prBanner = banner;
  scrollBottom();
}

function updateHeader(data) {
  const phase = data.phase || 'idle';
  badge.textContent = phase.toUpperCase();
  badge.className = 'badge ' + (
    phase === 'idle'     ? 'badge-idle' :
    phase === 'complete' ? 'badge-done' :
    phase === 'stopped'  ? 'badge-error' : 'badge-active'
  );
  if (data.completed !== undefined) {
    progressText.textContent = `${data.completed}/${data.total || '?'} items Â· ${data.branch || ''}`;
  } else if (data.items_done !== undefined) {
    progressText.textContent = `${data.items_done}/${data.items_total || '?'} items Â· ${data.branch || ''}`;
  } else if (data.progress) {
    progressText.textContent = data.progress;
  }

  // Repo ref indicator
  const repoEl = document.getElementById('repoRef');
  if (repoEl && data.repo_ref) {
    repoEl.textContent = data.repo_ref;
    repoEl.style.display = '';
  }

  // Issue badge
  const issueBadgeEl = document.getElementById('issueBadge');
  if (issueBadgeEl) {
    const ir = data.issue_ref;
    if (ir && ir.issue_id) {
      const icon = ir.platform === 'gitlab' ? 'ğŸ¦Š' : 'ğŸ™';
      issueBadgeEl.textContent = `${icon} #${ir.issue_id}`;
      issueBadgeEl.style.display = '';
    } else if (phase === 'idle' || phase === 'complete') {
      // Clear badge once done
      issueBadgeEl.style.display = 'none';
    }
  }

  // Sync token budget from /api/status response
  const budget = data.token_budget;
  if (budget && typeof budget === 'object') {
    const costUsd = budget.total_cost_usd ?? 0;
    const totalTok = budget.total_tokens ?? 0;
    if (costUsd > 0 || totalTok > 0) {
      _costData = budget;
      _totalCostUsd = costUsd;
      const btn = document.getElementById('costBtn');
      if (btn) {
        btn.style.display = '';
        btn.textContent = `ğŸ’° $${costUsd.toFixed(4)}`;
        btn.classList.remove('cost-soft', 'cost-hard');
        if (budget.hard_limit_hit) btn.classList.add('cost-hard');
        else if (budget.soft_limit_hit) btn.classList.add('cost-soft');
      }
    }
  }
}

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ws;
let _lastEventSeq = 0;
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}/ws`);
  ws.onopen = () => {};
  ws.onclose = () => setTimeout(connectWS, 3000);
  ws.onerror = () => {};
  ws.onmessage = (e) => {
    let msg;
    try {
      msg = JSON.parse(e.data);
    } catch (err) {
      console.warn('WS parse error:', err, e.data);
      return;
    }
    try {
      console.log('WS event:', msg);
      if (msg.type === 'event') handleEvent(msg.data);
      else if (msg.type === 'status') updateHeader(msg.data);
      else if (msg.type === 'error') addStatus(`âŒ ${msg.data.message}`, 'status-error');
      else if (msg.type === 'ack') addStatus(`âœ“ ${msg.data}`);
    } catch (err) {
      console.warn('WS handle error:', err, {
        type: msg?.type,
        category: msg?.data?.category,
        title: msg?.data?.title,
        seq: msg?.data?.seq,
      });
    }
  };
}

function sendTask() {
  const task = input.value.trim();
  if (!task) return;
  addUser(task);
  input.value = '';
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'task', task }));
  } else {
    fetch('/api/task', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ task }) })
      .then(r => r.json()).then(d => addStatus(`âœ“ Task queued`))
      .catch(e => addStatus(`âŒ Failed: ${e}`, 'status-error'));
  }
}


// â”€â”€ Intelligence Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _intelVisible = false;

function toggleIntel() {
  _intelVisible = !_intelVisible;
  const panel = document.getElementById('intelPanel');
  const btn   = document.getElementById('intelBtn');
  panel.style.display = _intelVisible ? 'flex' : 'none';
  btn.classList.toggle('active', _intelVisible);
  if (_intelVisible) loadIntelligence();
}

async function loadIntelligence() {
  const body = document.getElementById('intelBody');
  const cacheBadge = document.getElementById('intelCacheBadge');
  body.innerHTML = '<div class="intel-loading">Loadingâ€¦</div>';

  try {
    const [summary, smells, depGraph] = await Promise.all([
      fetch('/api/intelligence-summary').then(r => r.json()),
      fetch('/api/code-smells').then(r => r.json()),
      fetch('/api/dependency-graph').then(r => r.json()),
    ]);

    if (!summary.available) {
      body.innerHTML = '<div class="intel-empty">No intelligence data available yet.<br>Start a task to analyse the repository.</div>';
      cacheBadge.textContent = '';
      return;
    }

    cacheBadge.textContent = summary.cached ? `CACHED @ ${summary.cache_key || '?'}` : 'LIVE';

    const sections = [];

    // â”€â”€ Overview cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const staticErr  = summary.static?.errors  || 0;
    const staticWarn = summary.static?.warnings || 0;
    const smellErr   = summary.smells?.errors   || 0;
    const smellWarn  = summary.smells?.warnings || 0;
    const cycles     = summary.dependency_graph?.cycles || 0;
    const funcs      = summary.call_graph?.functions || 0;

    sections.push(`
      <div class="intel-section">
        <div class="intel-section-hdr" onclick="toggleSection(this)">
          <span class="s-icon">ğŸ“Š</span><span class="s-title">Overview</span>
        </div>
        <div class="intel-section-body">
          <div class="intel-cards">
            <div class="intel-card ${staticErr > 0 ? 'c-err' : 'c-ok'}">
              <div class="c-label">Static Errors</div>
              <div class="c-value">${staticErr}</div>
              <div class="c-sub">${staticWarn} warning(s)</div>
            </div>
            <div class="intel-card ${smellErr > 0 ? 'c-err' : smellWarn > 0 ? 'c-warn' : 'c-ok'}">
              <div class="c-label">Code Smells</div>
              <div class="c-value">${summary.smells?.total || 0}</div>
              <div class="c-sub">${smellErr} error(s), ${smellWarn} warning(s)</div>
            </div>
            <div class="intel-card ${cycles > 0 ? 'c-err' : 'c-ok'}">
              <div class="c-label">Dep Cycles</div>
              <div class="c-value">${cycles}</div>
              <div class="c-sub">${summary.dependency_graph?.modules || 0} modules</div>
            </div>
            <div class="intel-card c-info">
              <div class="c-label">Functions</div>
              <div class="c-value">${funcs}</div>
              <div class="c-sub">${summary.call_graph?.edges || 0} call edges</div>
            </div>
          </div>
        </div>
      </div>`);

    // â”€â”€ Circular imports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const cycleList = depGraph.cycles || [];
    if (cycleList.length > 0) {
      const rows = cycleList.slice(0, 10).map(cycle =>
        `<div class="cycle-path">â­® ${esc(cycle.join(' â†’ '))} â†’ ${esc(cycle[0])}</div>`
      ).join('');
      const more = cycleList.length > 10
        ? `<div class="cycle-path" style="color:var(--text-dim)">â€¦ and ${cycleList.length - 10} more</div>` : '';
      sections.push(`
        <div class="intel-section">
          <div class="intel-section-hdr" onclick="toggleSection(this)">
            <span class="s-icon">â­®</span><span class="s-title">Circular Imports</span>
            <span class="s-count s-count-error">${cycleList.length}</span>
          </div>
          <div class="intel-section-body">${rows}${more}</div>
        </div>`);
    }

    // â”€â”€ Most-coupled modules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const depJson = depGraph.json || {};
    const couplingScores = depJson.coupling_scores || {};
    const topCoupled = Object.entries(couplingScores)
      .sort((a, b) => b[1] - a[1]).slice(0, 8);
    if (topCoupled.length > 0) {
      const rows = topCoupled.map(([mod, score]) => {
        const pct = Math.round(score * 100);
        return `
          <div class="coupling-row">
            <span style="flex:1;color:var(--text);font-size:11px;word-break:break-all">${esc(mod)}</span>
            <div class="coupling-bar-bg"><div class="coupling-bar" style="width:${pct}%"></div></div>
            <span class="coupling-score">${pct}%</span>
          </div>`;
      }).join('');
      sections.push(`
        <div class="intel-section">
          <div class="intel-section-hdr" onclick="toggleSection(this)">
            <span class="s-icon">ğŸ”—</span><span class="s-title">Most Coupled Modules</span>
          </div>
          <div class="intel-section-body">${rows}</div>
        </div>`);
    }

    // â”€â”€ Code smells â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const allSmells = smells.smells || [];
    if (allSmells.length > 0) {
      const shown = allSmells.slice(0, 20);
      const rows = shown.map(s => {
        const sevClass = s.severity === 'error' ? 'r-sev-error'
                       : s.severity === 'warning' ? 'r-sev-warning' : 'r-sev-info';
        return `
          <div class="intel-row">
            <span class="r-sev ${sevClass}">${s.severity.toUpperCase()}</span>
            <span class="r-text">
              <strong>${esc(s.smell_type)}</strong> â€” ${esc(s.description)}
              ${s.suggestion ? `<br><span style="color:var(--text-dim);font-size:10.5px">ğŸ’¡ ${esc(s.suggestion)}</span>` : ''}
            </span>
            <span class="r-loc">${esc(s.file)}:${s.line}</span>
          </div>`;
      }).join('');
      const more = allSmells.length > 20
        ? `<div class="intel-row" style="color:var(--text-faint)">â€¦ and ${allSmells.length - 20} more</div>` : '';
      const errCount  = smells.errors   || 0;
      const warnCount = smells.warnings || 0;
      const countClass = errCount > 0 ? 's-count-error' : warnCount > 0 ? 's-count-warning' : 's-count-ok';
      sections.push(`
        <div class="intel-section">
          <div class="intel-section-hdr" onclick="toggleSection(this)">
            <span class="s-icon">ğŸ”</span><span class="s-title">Code Smells</span>
            <span class="s-count ${countClass}">${allSmells.length}</span>
          </div>
          <div class="intel-section-body">${rows}${more}</div>
        </div>`);
    }

    body.innerHTML = sections.join('') || '<div class="intel-empty">All clear â€” no issues detected.</div>';

  } catch (err) {
    body.innerHTML = `<div class="intel-empty">Failed to load intelligence data.<br><small style="color:var(--text-faint)">${esc(String(err))}</small></div>`;
    console.error('intel load error:', err);
  }
}

function toggleSection(hdr) {
  hdr.closest('.intel-section').classList.toggle('collapsed');
}

// Auto-refresh intel panel on intelligence_complete event
function _onIntelligenceComplete() {
  if (_intelVisible) loadIntelligence();
  // Flash the button to signal new data
  const btn = document.getElementById('intelBtn');
  btn.style.background = 'var(--green-dim)';
  btn.style.color = 'var(--green)';
  setTimeout(() => {
    btn.style.background = '';
    btn.style.color = '';
  }, 2000);
}

input.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendTask(); });
connectWS();

// On page load, check if a task is already waiting for approval or a coder answer
fetch('/api/status').then(r => r.json()).then(data => {
  updateHeader(data);
  if (data.phase === 'waiting_for_approval' && !_approvalPanel) {
    fetch('/api/pending').then(r => r.json()).then(p => {
      if (p && p.needs_human_approval) showApprovalPanel(p.pending_approval || {});
    }).catch(() => {});
  }
  if (data.phase === 'waiting_for_answer' && !_questionPanel) {
    fetch('/api/question').then(r => r.json()).then(q => {
      if (q && q.needs_coder_answer) showQuestionPanel(q.coder_question || {});
    }).catch(() => {});
  }
  if (data.phase === 'waiting_for_plan_approval' && !hasPlanApprovalPanel()) {
    const items = data.pending_plan_items || [];
    showPlanApprovalPanel({ items, items_count: items.length, plan_summary: '' });
  }
  // Restore PR banner if task already completed with a PR
  if (data.pr_result && !_prBanner) {
    showPrBanner(data.pr_result);
  }
  // Restore issue card if task is in progress with an issue
  if (data.issue_ref && data.phase !== 'idle') {
    const ir = data.issue_ref;
    const icon = ir.platform === 'gitlab' ? 'ğŸ¦Š' : 'ğŸ™';
    const badgeEl = document.getElementById('issueBadge');
    if (badgeEl) { badgeEl.textContent = `${icon} #${ir.issue_id}`; badgeEl.style.display = ''; }
  }
}).catch(() => {});

setInterval(() => {
  fetch('/api/status').then(r => r.json()).then(data => {
    updateHeader(data);
    // Restore plan approval panel if we're waiting and it's not visible
    if (data.phase === 'waiting_for_plan_approval' && !hasPlanApprovalPanel()) {
      const items = data.pending_plan_items || [];
      showPlanApprovalPanel({ items, items_count: items.length, plan_summary: '' });
    }
    // Show PR banner if completed and not yet visible
    if (data.pr_result && !_prBanner) {
      showPrBanner(data.pr_result);
    }
  }).catch(() => {});
}, 5000);
</script>
</body>
</html>
