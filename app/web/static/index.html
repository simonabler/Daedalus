<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daedalus</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');
  :root {
    --bg: #0c0e14;
    --surface: #151821;
    --surface2: #1c2030;
    --surface3: #242a3a;
    --border: #2a3045;
    --border-light: #353d55;
    --text: #d8dce8;
    --text-dim: #7b839a;
    --text-faint: #555d74;
    --accent: #6e8eff;
    --accent-dim: #3d5099;
    --green: #4ade80;
    --green-dim: #1a3a2a;
    --red: #f87171;
    --red-dim: #3a1a1a;
    --yellow: #fbbf24;
    --yellow-dim: #3a2e10;
    --purple: #a78bfa;
    --cyan: #67e8f9;
    --font: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: var(--font); background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 20px; background: var(--surface); border-bottom: 1px solid var(--border);
  }
  header h1 { font-size: 14px; font-weight: 700; letter-spacing: 2px; color: var(--accent); }
  .header-status { display: flex; align-items: center; gap: 12px; }
  .badge {
    padding: 3px 10px; border-radius: 10px; font-size: 10px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.8px;
  }
  .badge-idle { background: var(--surface3); color: var(--text-dim); }
  .badge-active { background: var(--green-dim); color: var(--green); animation: pulse 2s infinite; }
  .badge-error { background: var(--red-dim); color: var(--red); }
  .badge-done { background: var(--green-dim); color: var(--green); }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
  .progress-text { font-size: 11px; color: var(--text-dim); }

  /* â”€â”€ Main layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

  /* â”€â”€ Chat area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .chat { flex: 1; overflow-y: auto; padding: 16px 20px; display: flex; flex-direction: column; gap: 6px; }
  .chat::-webkit-scrollbar { width: 5px; }
  .chat::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* â”€â”€ Message types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .msg { max-width: 90%; border-radius: 8px; font-size: 12.5px; line-height: 1.6; }
  .msg-user {
    align-self: flex-end; background: var(--accent-dim); color: #fff;
    padding: 10px 14px; margin-top: 8px;
  }

  /* Status messages â€” always visible, prominent */
  .msg-status {
    align-self: flex-start; padding: 8px 14px;
    background: var(--surface2); border-left: 3px solid var(--accent);
    color: var(--text); font-weight: 500;
  }
  .msg-status.status-plan {
    border-left-color: var(--purple); background: #1a1530;
    white-space: pre-wrap; padding: 12px 16px;
  }
  .msg-status.status-verdict-approve { border-left-color: var(--green); }
  .msg-status.status-verdict-rework { border-left-color: var(--yellow); }
  .msg-status.status-verdict-pass { border-left-color: var(--green); }
  .msg-status.status-verdict-fail { border-left-color: var(--red); }
  .msg-status.status-commit { border-left-color: var(--cyan); }
  .msg-status.status-error { border-left-color: var(--red); background: var(--red-dim); color: var(--red); }
  .msg-status.status-complete { border-left-color: var(--green); background: var(--green-dim); color: var(--green); font-weight: 700; }

  /* Collapsible detail blocks â€” for agent internals */
  .msg-detail {
    align-self: flex-start; max-width: 95%; width: 100%;
  }
  .msg-detail details {
    background: var(--surface); border: 1px solid var(--border); border-radius: 6px;
    overflow: hidden;
  }
  .msg-detail summary {
    padding: 7px 12px; font-size: 11.5px; color: var(--text-dim); cursor: pointer;
    display: flex; align-items: center; gap: 8px; user-select: none;
    transition: background 0.15s;
  }
  .msg-detail summary:hover { background: var(--surface2); }
  .msg-detail summary::marker { content: ''; }
  .msg-detail summary .arrow {
    font-size: 9px; transition: transform 0.2s; color: var(--text-faint);
  }
  .msg-detail details[open] summary .arrow { transform: rotate(90deg); }
  .msg-detail .agent-tag {
    font-size: 9px; font-weight: 700; padding: 1px 6px; border-radius: 3px;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .tag-planner { background: #2a2050; color: var(--purple); }
  .tag-coder_a { background: #1a2a40; color: #60a5fa; }
  .tag-coder_b { background: #1a3030; color: #34d399; }
  .tag-reviewer_a { background: #2a1a40; color: #c084fc; }
  .tag-reviewer_b { background: #1a3a30; color: #6ee7b7; }
  .tag-documenter { background: #2d2532; color: #f9a8d4; }
  .tag-tester { background: #3a2a10; color: var(--yellow); }
  .tag-system { background: var(--surface3); color: var(--text-dim); }

  .msg-detail .detail-body {
    padding: 10px 14px; font-size: 11px; line-height: 1.5; color: var(--text-dim);
    white-space: pre-wrap; word-break: break-word; max-height: 400px; overflow-y: auto;
    border-top: 1px solid var(--border);
  }
  .msg-detail .detail-body::-webkit-scrollbar { width: 4px; }
  .msg-detail .detail-body::-webkit-scrollbar-thumb { background: var(--border); }

  /* Tool call sub-items inside details */
  .tool-item {
    margin: 4px 0; padding: 4px 8px; background: var(--surface2);
    border-radius: 4px; font-size: 10.5px;
  }
  .tool-item .tool-name { color: var(--cyan); font-weight: 600; }
  .tool-item .tool-args { color: var(--text-faint); }

  /* â”€â”€ Input row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .input-row {
    display: flex; gap: 8px; padding: 12px 20px;
    background: var(--surface); border-top: 1px solid var(--border);
  }
  .input-row input {
    flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 6px;
    background: var(--surface2); color: var(--text); font-family: var(--font);
    font-size: 12.5px; outline: none;
  }
  .input-row input:focus { border-color: var(--accent); }
  .input-row button {
    padding: 10px 24px; background: var(--accent); color: #fff; border: none;
    border-radius: 6px; font-family: var(--font); font-size: 12px; font-weight: 700;
    cursor: pointer; letter-spacing: 0.5px; transition: opacity 0.15s;
  }
  .input-row button:hover { opacity: 0.85; }
</style>
</head>
<body>
<header>
  <h1>âš™ Daedalus</h1>
  <div class="header-status">
    <span class="progress-text" id="progressText">â€”</span>
    <span class="badge badge-idle" id="badge">IDLE</span>
  </div>
</header>

<div class="main">
  <div class="chat" id="chat">
    <div class="msg msg-status">Ready. Enter a coding task to begin.</div>
  </div>
  <div class="input-row">
    <input type="text" id="taskInput" placeholder="Describe a coding taskâ€¦" autocomplete="off" />
    <button onclick="sendTask()">SEND</button>
  </div>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('taskInput');
const badge = document.getElementById('badge');
const progressText = document.getElementById('progressText');

// Track open detail blocks to group tool calls
let currentDetailBlock = null;
let currentDetailTools = null;

// â”€â”€ Agent tag colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TAG_CLASS = {
  planner: 'tag-planner', coder_a: 'tag-coder_a', coder_b: 'tag-coder_b',
  documenter: 'tag-documenter',
  reviewer_a: 'tag-reviewer_a', reviewer_b: 'tag-reviewer_b',
  tester: 'tag-tester', system: 'tag-system',
};

const AGENT_NAMES = {
  planner: 'PLANNER', coder_a: 'CODER A Â· Claude', coder_b: 'CODER B Â· GPT-5.2',
  documenter: 'DOCUMENTER',
  reviewer_a: 'REVIEWER A Â· Claude', reviewer_b: 'REVIEWER B Â· GPT-5.2',
  tester: 'TESTER', system: 'SYSTEM',
};

// â”€â”€ Scroll helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scrollBottom() {
  requestAnimationFrame(() => { chat.scrollTop = chat.scrollHeight; });
}

// â”€â”€ Add a prominent status message â”€â”€â”€â”€â”€â”€â”€
function addStatus(text, extraClass = '') {
  currentDetailBlock = null;
  const div = document.createElement('div');
  div.className = `msg msg-status ${extraClass}`;
  div.textContent = text;
  chat.appendChild(div);
  scrollBottom();
}

// â”€â”€ Add a user message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addUser(text) {
  currentDetailBlock = null;
  const div = document.createElement('div');
  div.className = 'msg msg-user';
  div.textContent = text;
  chat.appendChild(div);
  scrollBottom();
}

// â”€â”€ Add a collapsible detail block â”€â”€â”€â”€â”€â”€â”€
function addDetail(agent, title, body) {
  const wrapper = document.createElement('div');
  wrapper.className = 'msg msg-detail';

  const details = document.createElement('details');
  const summary = document.createElement('summary');

  const arrow = document.createElement('span');
  arrow.className = 'arrow';
  arrow.textContent = 'â–¶';

  const tag = document.createElement('span');
  tag.className = `agent-tag ${TAG_CLASS[agent] || 'tag-system'}`;
  tag.textContent = AGENT_NAMES[agent] || agent;

  const titleSpan = document.createElement('span');
  titleSpan.textContent = title;

  summary.appendChild(arrow);
  summary.appendChild(tag);
  summary.appendChild(titleSpan);
  details.appendChild(summary);

  if (body) {
    const bodyDiv = document.createElement('div');
    bodyDiv.className = 'detail-body';
    bodyDiv.textContent = body;
    details.appendChild(bodyDiv);
  }

  wrapper.appendChild(details);
  chat.appendChild(wrapper);
  currentDetailBlock = details;
  currentDetailTools = null;
  scrollBottom();
  return details;
}

// â”€â”€ Add tool call inside current detail block â”€â”€
function addToolCall(agent, toolName, args, result) {
  // If we have an open detail block from the same agent, append tool info
  if (!currentDetailBlock) {
    addDetail(agent, `ðŸ”§ Tool calls`, '');
  }

  // Find or create tool list inside the detail body
  let bodyDiv = currentDetailBlock.querySelector('.detail-body');
  if (!bodyDiv) {
    bodyDiv = document.createElement('div');
    bodyDiv.className = 'detail-body';
    currentDetailBlock.appendChild(bodyDiv);
  }

  const item = document.createElement('div');
  item.className = 'tool-item';
  item.innerHTML = `<span class="tool-name">âš¡ ${esc(toolName)}</span>`;
  if (args) item.innerHTML += ` <span class="tool-args">${esc(args)}</span>`;
  bodyDiv.appendChild(item);

  if (result) {
    const res = document.createElement('div');
    res.style.cssText = 'padding:2px 8px; font-size:10px; color:var(--text-faint); max-height:120px; overflow-y:auto; margin-bottom:4px;';
    res.textContent = result.substring(0, 500) + (result.length > 500 ? 'â€¦' : '');
    bodyDiv.appendChild(res);
  }
  scrollBottom();
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// â”€â”€ Handle incoming events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleEvent(evt) {
  const { category, agent, title, detail, metadata } = evt;

  switch (category) {
    case 'status':
      // Always show as prominent status line
      let cls = '';
      if (metadata?.phase === 'complete') cls = 'status-complete';
      else if (title.includes('âŒ') || title.includes('Error')) cls = 'status-error';
      addStatus(title, cls);
      if (metadata) {
        updateHeader({
          phase: metadata.phase || 'idle',
          completed: metadata.items_done,
          total: metadata.items_total,
          branch: metadata.branch || '',
        });
      }
      break;

    case 'plan':
      // Show plan prominently
      addStatus(title + '\n' + detail, 'status-plan');
      break;

    case 'verdict':
      // Show verdicts prominently
      const v = (metadata?.verdict || '').toLowerCase();
      const vcls = v === 'approve' ? 'status-verdict-approve'
                 : v === 'rework' ? 'status-verdict-rework'
                 : v === 'pass' ? 'status-verdict-pass'
                 : v === 'fail' ? 'status-verdict-fail' : '';
      addStatus(title, vcls);
      // Collapsible detail for the review content
      if (detail) addDetail(agent, `${AGENT_NAMES[agent] || agent} review details`, detail);
      break;

    case 'commit':
      addStatus(title, 'status-commit');
      break;

    case 'error':
      addStatus(title + (detail ? ': ' + detail : ''), 'status-error');
      break;

    case 'node_start':
      // Collapsible: "â–¶ Coding started â€” Working on: ..."
      addDetail(agent, title + (detail ? ` â€” ${detail}` : ''), '');
      break;

    case 'node_end':
      // Collapsible end summary
      if (detail) addDetail(agent, title, detail);
      break;

    case 'agent_think':
      // Collapsible: agent is thinking
      addDetail(agent, title, detail || '(processingâ€¦)');
      break;

    case 'agent_result':
      // Collapsible: agent response
      addDetail(agent, title, detail);
      break;

    case 'tool_call':
      addToolCall(agent, detail ? title.replace(`ðŸ”§ ${agent} â†’ `, '') : title, detail, '');
      break;

    case 'tool_result':
      // Append result to the current tool block
      addToolCall(agent, title.replace('ðŸ“Ž ', '').replace(' returned', ''), '', detail);
      break;

    default:
      // Unknown category â€” show as detail
      addDetail(agent, title, detail);
  }
}

// â”€â”€ Update header status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHeader(data) {
  const phase = data.phase || 'idle';
  badge.textContent = phase.toUpperCase();
  badge.className = 'badge ' + (
    phase === 'idle' ? 'badge-idle' :
    phase === 'complete' ? 'badge-done' :
    phase === 'stopped' ? 'badge-error' : 'badge-active'
  );
  if (data.completed !== undefined) {
    progressText.textContent = `${data.completed}/${data.total || '?'} items Â· ${data.branch || ''}`;
  } else if (data.progress) {
    progressText.textContent = data.progress;
  }
}

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ws;
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}/ws`);
  ws.onopen = () => {};
  ws.onclose = () => setTimeout(connectWS, 3000);
  ws.onerror = () => {};
  ws.onmessage = (e) => {
    try {
      const msg = JSON.parse(e.data);
      console.log('WS event:', msg);
      if (msg.type === 'event') handleEvent(msg.data);
      else if (msg.type === 'status') updateHeader(msg.data);
      else if (msg.type === 'error') addStatus(`âŒ ${msg.data.message}`, 'status-error');
      else if (msg.type === 'ack') addStatus(`âœ“ ${msg.data}`);
    } catch (err) { console.warn('WS parse error:', err, e.data); }
  };
}

function sendTask() {
  const task = input.value.trim();
  if (!task) return;
  addUser(task);
  input.value = '';
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'task', task }));
  } else {
    fetch('/api/task', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ task }) })
      .then(r => r.json()).then(d => addStatus(`âœ“ Task queued`))
      .catch(e => addStatus(`âŒ Failed: ${e}`, 'status-error'));
  }
}

input.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendTask(); });
connectWS();
setInterval(() => {
  if (!ws || ws.readyState !== WebSocket.OPEN) {
    fetch('/api/status').then(r => r.json()).then(updateHeader).catch(() => {});
  }
}, 5000);
</script>
</body>
</html>
