<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daedalus</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');
  :root {
    --bg: #0c0e14;
    --surface: #151821;
    --surface2: #1c2030;
    --surface3: #242a3a;
    --border: #2a3045;
    --border-light: #353d55;
    --text: #d8dce8;
    --text-dim: #7b839a;
    --text-faint: #555d74;
    --accent: #6e8eff;
    --accent-dim: #3d5099;
    --green: #4ade80;
    --green-dim: #1a3a2a;
    --red: #f87171;
    --red-dim: #3a1a1a;
    --yellow: #fbbf24;
    --yellow-dim: #3a2e10;
    --purple: #a78bfa;
    --cyan: #67e8f9;
    --font: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: var(--font); background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 20px; background: var(--surface); border-bottom: 1px solid var(--border);
  }
  header h1 { font-size: 14px; font-weight: 700; letter-spacing: 2px; color: var(--accent); }
  .header-status { display: flex; align-items: center; gap: 12px; }
  .badge {
    padding: 3px 10px; border-radius: 10px; font-size: 10px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.8px;
  }
  .badge-idle { background: var(--surface3); color: var(--text-dim); }
  .badge-active { background: var(--green-dim); color: var(--green); animation: pulse 2s infinite; }
  .badge-error { background: var(--red-dim); color: var(--red); }
  .badge-done { background: var(--green-dim); color: var(--green); }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
  .progress-text { font-size: 11px; color: var(--text-dim); }

  /* â”€â”€ Main layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

  /* â”€â”€ Chat area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .chat { flex: 1; overflow-y: auto; padding: 16px 20px; display: flex; flex-direction: column; gap: 6px; }
  .chat::-webkit-scrollbar { width: 5px; }
  .chat::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* â”€â”€ Message types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .msg { max-width: 90%; border-radius: 8px; font-size: 12.5px; line-height: 1.6; }
  .msg-user {
    align-self: flex-end; background: var(--accent-dim); color: #fff;
    padding: 10px 14px; margin-top: 8px;
  }

  /* Status messages â€” always visible, prominent */
  .msg-status {
    align-self: flex-start; padding: 8px 14px;
    background: var(--surface2); border-left: 3px solid var(--accent);
    color: var(--text); font-weight: 500;
  }
  .msg-status.status-plan {
    border-left-color: var(--purple); background: #1a1530;
    white-space: pre-wrap; padding: 12px 16px;
  }
  .msg-status.status-verdict-approve { border-left-color: var(--green); }
  .msg-status.status-verdict-rework { border-left-color: var(--yellow); }
  .msg-status.status-verdict-pass { border-left-color: var(--green); }
  .msg-status.status-verdict-fail { border-left-color: var(--red); }
  .msg-status.status-commit { border-left-color: var(--cyan); }
  .msg-status.status-error { border-left-color: var(--red); background: var(--red-dim); color: var(--red); }
  .msg-status.status-complete { border-left-color: var(--green); background: var(--green-dim); color: var(--green); font-weight: 700; }

  /* Collapsible detail blocks â€” for agent internals */
  .msg-detail {
    align-self: flex-start; max-width: 95%; width: 100%;
  }
  .msg-detail details {
    background: var(--surface); border: 1px solid var(--border); border-radius: 6px;
    overflow: hidden;
  }
  .msg-detail summary {
    padding: 7px 12px; font-size: 11.5px; color: var(--text-dim); cursor: pointer;
    display: flex; align-items: center; gap: 8px; user-select: none;
    transition: background 0.15s;
  }
  .msg-detail summary:hover { background: var(--surface2); }
  .msg-detail summary::marker { content: ''; }
  .msg-detail summary .arrow {
    font-size: 9px; transition: transform 0.2s; color: var(--text-faint);
  }
  .msg-detail details[open] summary .arrow { transform: rotate(90deg); }
  .msg-detail .agent-tag {
    font-size: 9px; font-weight: 700; padding: 1px 6px; border-radius: 3px;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .tag-planner { background: #2a2050; color: var(--purple); }
  .tag-coder_a { background: #1a2a40; color: #60a5fa; }
  .tag-coder_b { background: #1a3030; color: #34d399; }
  .tag-reviewer_a { background: #2a1a40; color: #c084fc; }
  .tag-reviewer_b { background: #1a3a30; color: #6ee7b7; }
  .tag-documenter { background: #2d2532; color: #f9a8d4; }
  .tag-tester { background: #3a2a10; color: var(--yellow); }
  .tag-system { background: var(--surface3); color: var(--text-dim); }

  .msg-detail .detail-body {
    padding: 10px 14px; font-size: 11px; line-height: 1.5; color: var(--text-dim);
    white-space: pre-wrap; word-break: break-word; max-height: 400px; overflow-y: auto;
    border-top: 1px solid var(--border);
  }
  .msg-detail .detail-body::-webkit-scrollbar { width: 4px; }
  .msg-detail .detail-body::-webkit-scrollbar-thumb { background: var(--border); }

  /* Tool call sub-items inside details */
  .tool-item {
    margin: 4px 0; padding: 4px 8px; background: var(--surface2);
    border-radius: 4px; font-size: 10.5px;
  }
  .tool-item .tool-name { color: var(--cyan); font-weight: 600; }
  .tool-item .tool-args { color: var(--text-faint); }

  /* â”€â”€ Input row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .input-row {
    display: flex; gap: 8px; padding: 12px 20px;
    background: var(--surface); border-top: 1px solid var(--border);
  }
  .input-row input {
    flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 6px;
    background: var(--surface2); color: var(--text); font-family: var(--font);
    font-size: 12.5px; outline: none;
  }
  .input-row input:focus { border-color: var(--accent); }
  .input-row button {
    padding: 10px 24px; background: var(--accent); color: #fff; border: none;
    border-radius: 6px; font-family: var(--font); font-size: 12px; font-weight: 700;
    cursor: pointer; letter-spacing: 0.5px; transition: opacity 0.15s;
  }
  .input-row button:hover { opacity: 0.85; }

  /* â”€â”€ Approval Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .approval-panel {
    margin: 8px 0; border-radius: 8px; overflow: hidden;
    border: 1px solid var(--yellow); background: #1e1a08;
    animation: slide-in 0.25s ease;
  }
  @keyframes slide-in { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }

  .approval-header {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 16px; background: #2a2308; border-bottom: 1px solid #3a3010;
  }
  .approval-header .approval-icon { font-size: 18px; }
  .approval-header .approval-title {
    flex: 1; font-size: 13px; font-weight: 700; color: var(--yellow); letter-spacing: 0.5px;
  }
  .approval-header .approval-summary { font-size: 11px; color: var(--text-dim); }

  .approval-triggers {
    padding: 8px 16px; display: flex; flex-wrap: wrap; gap: 6px;
    border-bottom: 1px solid #2a2210;
  }
  .trigger-pill {
    padding: 3px 9px; border-radius: 12px; font-size: 10px; font-weight: 600;
    letter-spacing: 0.4px; text-transform: uppercase;
  }
  .trigger-commit   { background: #1a2a40; color: #60a5fa; }
  .trigger-large    { background: #2a1f00; color: var(--yellow); }
  .trigger-deletion { background: #3a1010; color: var(--red); }
  .trigger-ci       { background: #1a1a40; color: var(--purple); }

  .approval-files {
    padding: 8px 16px; border-bottom: 1px solid #2a2210;
  }
  .approval-files .files-label {
    font-size: 10px; color: var(--text-faint); text-transform: uppercase; letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  .approval-files .file-list {
    display: flex; flex-direction: column; gap: 2px;
  }
  .approval-files .file-entry {
    font-size: 11px; color: var(--text-dim); padding: 1px 0;
  }
  .approval-files .file-entry::before { content: "â€¢ "; color: var(--text-faint); }

  .approval-diff {
    border-bottom: 1px solid #2a2210;
  }
  .approval-diff details summary {
    padding: 8px 16px; font-size: 11px; color: var(--text-faint); cursor: pointer;
    user-select: none; list-style: none; display: flex; align-items: center; gap: 6px;
  }
  .approval-diff details summary::marker { content: ''; }
  .approval-diff details summary .diff-arrow { font-size: 9px; transition: transform 0.2s; }
  .approval-diff details[open] summary .diff-arrow { transform: rotate(90deg); }
  .approval-diff .diff-body {
    padding: 10px 16px; font-size: 10.5px; line-height: 1.5; color: var(--text-dim);
    white-space: pre; overflow-x: auto; max-height: 300px; overflow-y: auto;
    border-top: 1px solid #2a2210; tab-size: 4;
  }
  .approval-diff .diff-body::-webkit-scrollbar { width: 4px; height: 4px; }
  .approval-diff .diff-body::-webkit-scrollbar-thumb { background: var(--border); }
  /* diff syntax colouring */
  .diff-add  { color: #4ade80; }
  .diff-del  { color: #f87171; }
  .diff-hunk { color: #67e8f9; }
  .diff-meta { color: var(--text-faint); }

  .approval-actions {
    display: flex; gap: 10px; padding: 12px 16px;
  }
  .btn-approve, .btn-reject {
    flex: 1; padding: 10px 0; border: none; border-radius: 6px;
    font-family: var(--font); font-size: 12px; font-weight: 700;
    letter-spacing: 0.8px; cursor: pointer; transition: opacity 0.15s, transform 0.1s;
  }
  .btn-approve { background: #166534; color: #4ade80; }
  .btn-approve:hover { background: #15803d; }
  .btn-reject  { background: #7f1d1d; color: #f87171; }
  .btn-reject:hover  { background: #991b1b; }
  .btn-approve:active, .btn-reject:active { transform: scale(0.97); }
  .btn-approve:disabled, .btn-reject:disabled {
    opacity: 0.4; cursor: default; transform: none;
  }

  /* â”€â”€ Coder Question Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .question-panel {
    margin: 8px 0; border-radius: 8px; overflow: hidden;
    border: 1px solid var(--purple); background: #130e1e;
    animation: slide-in 0.25s ease;
  }
  .question-header {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 16px; background: #1a1228; border-bottom: 1px solid #2a1a40;
  }
  .question-header .q-icon { font-size: 18px; }
  .question-header .q-title {
    flex: 1; font-size: 13px; font-weight: 700; color: var(--purple); letter-spacing: 0.5px;
  }
  .question-header .q-agent {
    font-size: 10px; padding: 2px 8px; border-radius: 8px;
    background: #2a1a40; color: #c084fc; font-weight: 700; text-transform: uppercase;
  }
  .question-body { padding: 14px 16px; border-bottom: 1px solid #2a1a40; }
  .question-text {
    font-size: 13px; color: var(--text); line-height: 1.6; margin-bottom: 0;
  }
  .question-context {
    margin-top: 8px; font-size: 11px; color: var(--text-dim); line-height: 1.5;
    padding: 8px 12px; background: var(--surface2); border-radius: 4px;
    border-left: 2px solid var(--purple);
  }
  .question-options {
    padding: 10px 16px; display: flex; flex-direction: column; gap: 6px;
    border-bottom: 1px solid #2a1a40;
  }
  .question-options .opt-label {
    font-size: 10px; color: var(--text-faint); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;
  }
  .btn-option {
    padding: 8px 14px; background: #1e1430; border: 1px solid #3a1a55;
    border-radius: 5px; color: #c084fc; font-family: var(--font); font-size: 11.5px;
    text-align: left; cursor: pointer; transition: background 0.15s, border-color 0.15s;
  }
  .btn-option:hover { background: #2a1a45; border-color: var(--purple); }
  .question-freetext {
    padding: 10px 16px; display: flex; gap: 8px;
  }
  .question-freetext .ft-label {
    font-size: 10px; color: var(--text-faint); text-transform: uppercase;
    letter-spacing: 0.5px; margin-bottom: 4px;
  }
  .question-freetext-inner { flex: 1; display: flex; flex-direction: column; gap: 6px; }
  .question-freetext input {
    padding: 8px 12px; border: 1px solid var(--border); border-radius: 5px;
    background: var(--surface2); color: var(--text); font-family: var(--font);
    font-size: 12px; outline: none;
  }
  .question-freetext input:focus { border-color: var(--purple); }
  .btn-answer {
    align-self: flex-end; padding: 8px 20px; background: var(--purple);
    color: #fff; border: none; border-radius: 5px; font-family: var(--font);
    font-size: 12px; font-weight: 700; cursor: pointer; transition: opacity 0.15s;
  }
  .btn-answer:hover { opacity: 0.85; }
  .btn-answer:disabled { opacity: 0.4; cursor: default; }

  /* â”€â”€ Intel button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .intel-btn {
    padding: 4px 12px; border-radius: 6px; border: 1px solid var(--border-light);
    background: var(--surface2); color: var(--accent); font-family: var(--font);
    font-size: 11px; font-weight: 700; cursor: pointer; transition: background 0.15s;
    letter-spacing: 0.5px;
  }
  .intel-btn:hover { background: var(--surface3); }
  .intel-btn.active { background: var(--accent-dim); border-color: var(--accent); }

  /* â”€â”€ Intelligence Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .intel-panel {
    position: fixed; top: 0; right: 0; bottom: 0; width: 380px; max-width: 100vw;
    background: var(--surface); border-left: 1px solid var(--border);
    display: flex; flex-direction: column; z-index: 100; overflow: hidden;
    box-shadow: -4px 0 24px rgba(0,0,0,0.4);
    animation: slide-in-right 0.2s ease;
  }
  @keyframes slide-in-right {
    from { transform: translateX(100%); opacity: 0; }
    to   { transform: translateX(0);   opacity: 1; }
  }
  .intel-header {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 14px; background: var(--surface2);
    border-bottom: 1px solid var(--border); flex-shrink: 0;
  }
  .intel-title { flex: 1; font-size: 11px; font-weight: 700; color: var(--accent); letter-spacing: 1.5px; }
  .intel-cache-badge {
    font-size: 9px; padding: 2px 7px; border-radius: 8px;
    background: var(--surface3); color: var(--text-dim); font-weight: 700;
  }
  .intel-refresh, .intel-close {
    background: none; border: none; color: var(--text-dim); cursor: pointer;
    font-size: 14px; padding: 2px 5px; border-radius: 4px; transition: color 0.15s;
    font-family: var(--font);
  }
  .intel-refresh:hover, .intel-close:hover { color: var(--text); }
  .intel-body { flex: 1; overflow-y: auto; padding: 12px 14px; display: flex; flex-direction: column; gap: 12px; }
  .intel-body::-webkit-scrollbar { width: 4px; }
  .intel-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .intel-loading { color: var(--text-dim); font-size: 12px; padding: 20px 0; text-align: center; }
  .intel-empty { color: var(--text-faint); font-size: 11px; text-align: center; padding: 40px 0; }

  /* Intel sections */
  .intel-section { border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
  .intel-section-hdr {
    display: flex; align-items: center; gap: 8px;
    padding: 7px 12px; background: var(--surface2);
    font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
    cursor: pointer; user-select: none;
  }
  .intel-section-hdr:hover { background: var(--surface3); }
  .intel-section-hdr .s-icon { font-size: 13px; }
  .intel-section-hdr .s-title { flex: 1; }
  .intel-section-hdr .s-count {
    padding: 1px 7px; border-radius: 8px; font-size: 9px; font-weight: 800;
  }
  .s-count-error { background: var(--red-dim); color: var(--red); }
  .s-count-warning { background: var(--yellow-dim); color: var(--yellow); }
  .s-count-ok { background: var(--green-dim); color: var(--green); }
  .s-count-info { background: var(--surface3); color: var(--text-dim); }
  .intel-section-body { padding: 8px 0; }
  .intel-section.collapsed .intel-section-body { display: none; }

  /* Intel rows */
  .intel-row {
    display: flex; align-items: flex-start; gap: 8px;
    padding: 5px 12px; font-size: 11.5px; line-height: 1.5; border-bottom: 1px solid var(--border);
  }
  .intel-row:last-child { border-bottom: none; }
  .intel-row .r-sev {
    font-size: 9px; font-weight: 800; padding: 1px 5px; border-radius: 3px; flex-shrink: 0; margin-top: 2px;
  }
  .r-sev-error { background: var(--red-dim); color: var(--red); }
  .r-sev-warning { background: var(--yellow-dim); color: var(--yellow); }
  .r-sev-info { background: var(--surface3); color: var(--text-dim); }
  .intel-row .r-text { flex: 1; color: var(--text); }
  .intel-row .r-loc { color: var(--text-faint); font-size: 10px; }

  /* Summary cards */
  .intel-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 8px 12px; }
  .intel-card {
    border-radius: 5px; padding: 8px 10px; background: var(--surface2);
    border: 1px solid var(--border);
  }
  .intel-card .c-label { font-size: 9px; color: var(--text-faint); text-transform: uppercase; letter-spacing: 0.8px; }
  .intel-card .c-value { font-size: 20px; font-weight: 700; color: var(--text); margin-top: 2px; }
  .intel-card .c-sub { font-size: 9px; color: var(--text-dim); margin-top: 1px; }
  .intel-card.c-err .c-value { color: var(--red); }
  .intel-card.c-warn .c-value { color: var(--yellow); }
  .intel-card.c-ok .c-value { color: var(--green); }
  .intel-card.c-info .c-value { color: var(--accent); }

  /* Cycle paths */
  .cycle-path {
    padding: 5px 12px; font-size: 11px; color: var(--red);
    border-bottom: 1px solid var(--border); word-break: break-all;
  }
  .cycle-path:last-child { border-bottom: none; }

  /* Coupling rows */
  .coupling-row {
    display: flex; align-items: center; gap: 8px; padding: 5px 12px;
    font-size: 11px; border-bottom: 1px solid var(--border);
  }
  .coupling-row:last-child { border-bottom: none; }
  .coupling-bar-bg { flex: 1; height: 4px; background: var(--surface3); border-radius: 2px; }
  .coupling-bar { height: 4px; border-radius: 2px; background: var(--accent); }
  .coupling-score { font-size: 10px; color: var(--text-dim); width: 32px; text-align: right; }
</style>
</head>
<body>
<header>
  <h1>âš™ Daedalus</h1>
  <div class="header-status">
    <span class="progress-text" id="progressText">â€”</span>
    <span class="badge badge-idle" id="badge">IDLE</span>
    <button class="intel-btn" id="intelBtn" onclick="toggleIntel()" title="Code Intelligence Dashboard">ğŸ§  Intel</button>
  </div>
</header>

<div class="main">
  <div class="chat" id="chat">
    <div class="msg msg-status">Ready. Enter a coding task to begin.</div>
  </div>
  <div class="input-row">
    <input type="text" id="taskInput" placeholder="Describe a coding taskâ€¦" autocomplete="off" />
    <button onclick="sendTask()">SEND</button>
  </div>
</div>

<!-- Intelligence Dashboard Panel -->
<div class="intel-panel" id="intelPanel" style="display:none">
  <div class="intel-header">
    <span class="intel-title">ğŸ§  CODE INTELLIGENCE</span>
    <span class="intel-cache-badge" id="intelCacheBadge"></span>
    <button class="intel-refresh" onclick="loadIntelligence()" title="Refresh">â†»</button>
    <button class="intel-close" onclick="toggleIntel()" title="Close">âœ•</button>
  </div>
  <div class="intel-body" id="intelBody">
    <div class="intel-loading">Loading intelligence dataâ€¦</div>
  </div>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('taskInput');
const badge = document.getElementById('badge');
const progressText = document.getElementById('progressText');

// Track open detail blocks to group tool calls
let currentDetailBlock = null;
let currentDetailTools = null;

// â”€â”€ Agent tag colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TAG_CLASS = {
  planner: 'tag-planner', coder_a: 'tag-coder_a', coder_b: 'tag-coder_b',
  documenter: 'tag-documenter',
  reviewer_a: 'tag-reviewer_a', reviewer_b: 'tag-reviewer_b',
  tester: 'tag-tester', system: 'tag-system',
};

const AGENT_NAMES = {
  planner: 'PLANNER', coder_a: 'CODER A Â· Claude', coder_b: 'CODER B Â· GPT-5.2',
  documenter: 'DOCUMENTER',
  reviewer_a: 'REVIEWER A Â· Claude', reviewer_b: 'REVIEWER B Â· GPT-5.2',
  tester: 'TESTER', system: 'SYSTEM',
};

// â”€â”€ Scroll helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scrollBottom() {
  requestAnimationFrame(() => { chat.scrollTop = chat.scrollHeight; });
}

// â”€â”€ Add a prominent status message â”€â”€â”€â”€â”€â”€â”€
function addStatus(text, extraClass = '') {
  currentDetailBlock = null;
  const div = document.createElement('div');
  div.className = `msg msg-status ${extraClass}`;
  div.textContent = text;
  chat.appendChild(div);
  scrollBottom();
}

// â”€â”€ Add a user message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addUser(text) {
  currentDetailBlock = null;
  const div = document.createElement('div');
  div.className = 'msg msg-user';
  div.textContent = text;
  chat.appendChild(div);
  scrollBottom();
}

// â”€â”€ Add a collapsible detail block â”€â”€â”€â”€â”€â”€â”€
function addDetail(agent, title, body) {
  const wrapper = document.createElement('div');
  wrapper.className = 'msg msg-detail';

  const details = document.createElement('details');
  const summary = document.createElement('summary');

  const arrow = document.createElement('span');
  arrow.className = 'arrow';
  arrow.textContent = 'â–¶';

  const tag = document.createElement('span');
  tag.className = `agent-tag ${TAG_CLASS[agent] || 'tag-system'}`;
  tag.textContent = AGENT_NAMES[agent] || agent;

  const titleSpan = document.createElement('span');
  titleSpan.textContent = title;

  summary.appendChild(arrow);
  summary.appendChild(tag);
  summary.appendChild(titleSpan);
  details.appendChild(summary);

  if (body) {
    const bodyDiv = document.createElement('div');
    bodyDiv.className = 'detail-body';
    bodyDiv.textContent = body;
    details.appendChild(bodyDiv);
  }

  wrapper.appendChild(details);
  chat.appendChild(wrapper);
  currentDetailBlock = details;
  currentDetailTools = null;
  scrollBottom();
  return details;
}

// â”€â”€ Add tool call inside current detail block â”€â”€
function addToolCall(agent, toolName, args, result) {
  // If we have an open detail block from the same agent, append tool info
  if (!currentDetailBlock) {
    addDetail(agent, `ğŸ”§ Tool calls`, '');
  }

  // Find or create tool list inside the detail body
  let bodyDiv = currentDetailBlock.querySelector('.detail-body');
  if (!bodyDiv) {
    bodyDiv = document.createElement('div');
    bodyDiv.className = 'detail-body';
    currentDetailBlock.appendChild(bodyDiv);
  }

  const item = document.createElement('div');
  item.className = 'tool-item';
  item.innerHTML = `<span class="tool-name">âš¡ ${esc(toolName)}</span>`;
  if (args) item.innerHTML += ` <span class="tool-args">${esc(args)}</span>`;
  bodyDiv.appendChild(item);

  if (result) {
    const res = document.createElement('div');
    res.style.cssText = 'padding:2px 8px; font-size:10px; color:var(--text-faint); max-height:120px; overflow-y:auto; margin-bottom:4px;';
    res.textContent = result.substring(0, 500) + (result.length > 500 ? 'â€¦' : '');
    bodyDiv.appendChild(res);
  }
  scrollBottom();
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// â”€â”€ Diff syntax highlighting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDiff(raw) {
  return raw.split('\n').map(line => {
    const e = esc(line);
    if (line.startsWith('+') && !line.startsWith('+++')) return `<span class="diff-add">${e}</span>`;
    if (line.startsWith('-') && !line.startsWith('---')) return `<span class="diff-del">${e}</span>`;
    if (line.startsWith('@@'))  return `<span class="diff-hunk">${e}</span>`;
    if (line.startsWith('diff') || line.startsWith('index') || line.startsWith('---') || line.startsWith('+++'))
      return `<span class="diff-meta">${e}</span>`;
    return e;
  }).join('\n');
}

// â”€â”€ Build and insert the approval panel â”€â”€â”€â”€â”€â”€
let _approvalPanel = null;

function showApprovalPanel(meta) {
  currentDetailBlock = null;

  // Remove any existing panel first (shouldn't happen, but be safe)
  if (_approvalPanel) _approvalPanel.remove();

  const panel = document.createElement('div');
  panel.className = 'approval-panel';

  // Trigger pills
  const triggerPillsHTML = (meta.triggers || []).map(t => {
    const cls = t.type === 'commit'       ? 'trigger-commit'
              : t.type === 'large_diff'   ? 'trigger-large'
              : t.type === 'file_deletion'? 'trigger-deletion'
              : t.type === 'ci_config_change' ? 'trigger-ci' : 'trigger-commit';
    return `<span class="trigger-pill ${cls}">${esc(t.reason)}</span>`;
  }).join('');

  // File list (max 20 shown)
  const files = meta.files || [];
  const fileListHTML = files.slice(0, 20).map(f =>
    `<div class="file-entry">${esc(f)}</div>`
  ).join('') + (files.length > 20
    ? `<div class="file-entry" style="color:var(--text-faint)">â€¦ and ${files.length - 20} more</div>`
    : '');

  // Diff preview
  const diffRaw = meta.diff_preview || '';
  const diffSection = diffRaw ? `
    <div class="approval-diff">
      <details>
        <summary>
          <span class="diff-arrow">â–¶</span>
          Show diff preview (${diffRaw.split('\n').length} lines)
        </summary>
        <div class="diff-body">${renderDiff(diffRaw)}</div>
      </details>
    </div>` : '';

  panel.innerHTML = `
    <div class="approval-header">
      <span class="approval-icon">âš ï¸</span>
      <span class="approval-title">HUMAN APPROVAL REQUIRED</span>
      <span class="approval-summary">${esc(meta.summary || '')}</span>
    </div>
    <div class="approval-triggers">${triggerPillsHTML}</div>
    <div class="approval-files">
      <div class="files-label">Changed files</div>
      <div class="file-list">${fileListHTML || '<div class="file-entry" style="color:var(--text-faint)">No staged files detected</div>'}</div>
    </div>
    ${diffSection}
    <div class="approval-actions">
      <button class="btn-approve" id="btnApprove">âœ… APPROVE</button>
      <button class="btn-reject"  id="btnReject">âŒ REJECT</button>
    </div>`;

  chat.appendChild(panel);
  _approvalPanel = panel;
  scrollBottom();

  // Wire buttons
  panel.querySelector('#btnApprove').addEventListener('click', () => submitApproval(true, panel));
  panel.querySelector('#btnReject').addEventListener('click',  () => submitApproval(false, panel));
}

async function submitApproval(approved, panel) {
  const btnApprove = panel.querySelector('#btnApprove');
  const btnReject  = panel.querySelector('#btnReject');
  btnApprove.disabled = true;
  btnReject.disabled  = true;
  btnApprove.textContent = approved ? 'â³ Approvingâ€¦' : 'âœ… APPROVE';
  btnReject.textContent  = approved ? 'âŒ REJECT' : 'â³ Rejectingâ€¦';

  try {
    const res = await fetch('/api/approve', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ approved }),
    });
    const data = await res.json();
    if (data.error) {
      addStatus(`âŒ Approval error: ${data.error}`, 'status-error');
      btnApprove.disabled = false;
      btnReject.disabled  = false;
      btnApprove.textContent = 'âœ… APPROVE';
      btnReject.textContent  = 'âŒ REJECT';
      return;
    }
    // Replace panel with confirmation
    const confirmEl = document.createElement('div');
    confirmEl.className = `msg msg-status ${approved ? 'status-verdict-approve' : 'status-error'}`;
    confirmEl.textContent = approved
      ? 'âœ… Approved â€” workflow continuing to commitâ€¦'
      : 'âŒ Rejected â€” workflow stopped.';
    panel.replaceWith(confirmEl);
    _approvalPanel = null;
    scrollBottom();
  } catch (err) {
    addStatus(`âŒ Network error: ${err}`, 'status-error');
    btnApprove.disabled = false;
    btnReject.disabled  = false;
    btnApprove.textContent = 'âœ… APPROVE';
    btnReject.textContent  = 'âŒ REJECT';
  }
}

// â”€â”€ Coder Question Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _questionPanel = null;

function showQuestionPanel(meta) {
  currentDetailBlock = null;
  if (_questionPanel) _questionPanel.remove();

  const panel = document.createElement('div');
  panel.className = 'question-panel';

  const agentLabel = meta.asked_by === 'coder_a' ? 'CODER A Â· Claude' : 'CODER B Â· GPT';

  const contextHtml = meta.context
    ? `<div class="question-context">${esc(meta.context)}</div>` : '';

  const options = meta.options || [];
  const optionsHtml = options.length
    ? `<div class="question-options">
        <div class="opt-label">Quick answers</div>
        ${options.map((o, i) => `<button class="btn-option" data-idx="${i}">${esc(o)}</button>`).join('')}
      </div>` : '';

  panel.innerHTML = `
    <div class="question-header">
      <span class="q-icon">ğŸ¤”</span>
      <span class="q-title">CODER IS ASKING</span>
      <span class="q-agent">${esc(agentLabel)}</span>
    </div>
    <div class="question-body">
      <div class="question-text">${esc(meta.question)}</div>
      ${contextHtml}
    </div>
    ${optionsHtml}
    <div class="question-freetext">
      <div class="question-freetext-inner">
        <div class="ft-label">Custom answer</div>
        <input type="text" id="answerInput" placeholder="Type your answerâ€¦" autocomplete="off" />
        <button class="btn-answer" id="btnAnswer">SEND</button>
      </div>
    </div>`;

  chat.appendChild(panel);
  _questionPanel = panel;
  scrollBottom();

  // Option buttons
  panel.querySelectorAll('.btn-option').forEach(btn => {
    btn.addEventListener('click', () => submitAnswer(btn.textContent.trim(), panel));
  });

  // Free-text send
  panel.querySelector('#btnAnswer').addEventListener('click', () => {
    const val = panel.querySelector('#answerInput').value.trim();
    if (val) submitAnswer(val, panel);
  });
  panel.querySelector('#answerInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const val = panel.querySelector('#answerInput').value.trim();
      if (val) submitAnswer(val, panel);
    }
  });
}

async function submitAnswer(answer, panel) {
  const btn = panel.querySelector('#btnAnswer');
  const input = panel.querySelector('#answerInput');
  if (btn) btn.disabled = true;
  if (input) input.disabled = true;
  panel.querySelectorAll('.btn-option').forEach(b => b.disabled = true);

  try {
    const res = await fetch('/api/answer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ answer }),
    });
    const data = await res.json();
    if (data.error) {
      addStatus(`âŒ Answer error: ${data.error}`, 'status-error');
      if (btn) btn.disabled = false;
      if (input) input.disabled = false;
      panel.querySelectorAll('.btn-option').forEach(b => b.disabled = false);
      return;
    }
    const confirmEl = document.createElement('div');
    confirmEl.className = 'msg msg-status status-verdict-approve';
    confirmEl.textContent = `ğŸ’¬ Answer sent: "${answer}" â€” coder will continue.`;
    panel.replaceWith(confirmEl);
    _questionPanel = null;
    scrollBottom();
  } catch (err) {
    addStatus(`âŒ Network error: ${err}`, 'status-error');
    if (btn) btn.disabled = false;
    if (input) input.disabled = false;
    panel.querySelectorAll('.btn-option').forEach(b => b.disabled = false);
  }
}

// â”€â”€ Handle incoming events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleEvent(evt) {
  const { category, agent, title, detail, metadata } = evt;

  switch (category) {
    case 'status':
      // Always show as prominent status line
      let cls = '';
      if (metadata?.phase === 'complete') cls = 'status-complete';
      else if (title.includes('âŒ') || title.includes('Error')) cls = 'status-error';
      addStatus(title, cls);
      if (metadata) {
        updateHeader({
          phase: metadata.phase || 'idle',
          completed: metadata.items_done,
          total: metadata.items_total,
          branch: metadata.branch || '',
        });
        // Detect intelligence_complete event metadata
        if (metadata.type === 'intelligence_complete') {
          _onIntelligenceComplete();
        }
      }
      break;

    case 'plan':
      // Show plan prominently
      addStatus(title + '\n' + detail, 'status-plan');
      break;

    case 'verdict':
      // Show verdicts prominently
      const v = (metadata?.verdict || '').toLowerCase();
      const vcls = v === 'approve' ? 'status-verdict-approve'
                 : v === 'rework' ? 'status-verdict-rework'
                 : v === 'pass' ? 'status-verdict-pass'
                 : v === 'fail' ? 'status-verdict-fail' : '';
      addStatus(title, vcls);
      // Collapsible detail for the review content
      if (detail) addDetail(agent, `${AGENT_NAMES[agent] || agent} review details`, detail);
      break;

    case 'commit':
      addStatus(title, 'status-commit');
      break;

    case 'error':
      addStatus(title + (detail ? ': ' + detail : ''), 'status-error');
      break;

    case 'approval_needed':
      showApprovalPanel(metadata || {});
      break;

    case 'approval_done':
      // Panel was already replaced by submitApproval(); this just ensures
      // any late-joining client (reconnect) also sees the outcome.
      if (_approvalPanel) {
        const approved = metadata?.approved;
        const confirmEl = document.createElement('div');
        confirmEl.className = `msg msg-status ${approved ? 'status-verdict-approve' : 'status-error'}`;
        confirmEl.textContent = approved
          ? 'âœ… Approved â€” workflow continuing to commitâ€¦'
          : 'âŒ Rejected â€” workflow stopped.';
        _approvalPanel.replaceWith(confirmEl);
        _approvalPanel = null;
        scrollBottom();
      }
      break;

    case 'coder_question':
      showQuestionPanel(metadata || {});
      break;

    case 'coder_answer':
      // Panel replaced by submitAnswer(); handle reconnect case
      if (_questionPanel) {
        const answerText = metadata?.answer || '';
        const confirmEl = document.createElement('div');
        confirmEl.className = 'msg msg-status status-verdict-approve';
        confirmEl.textContent = `ğŸ’¬ Answer sent: "${answerText}" â€” coder will continue.`;
        _questionPanel.replaceWith(confirmEl);
        _questionPanel = null;
        scrollBottom();
      }
      break;

    case 'node_start':
      // Collapsible: "â–¶ Coding started â€” Working on: ..."
      addDetail(agent, title + (detail ? ` â€” ${detail}` : ''), '');
      break;

    case 'node_end':
      // Collapsible end summary
      if (detail) addDetail(agent, title, detail);
      break;

    case 'agent_think':
      // Collapsible: agent is thinking
      addDetail(agent, title, detail || '(processingâ€¦)');
      break;

    case 'agent_result':
      // Collapsible: agent response
      addDetail(agent, title, detail);
      break;

    case 'tool_call':
      addToolCall(agent, detail ? title.replace(`ğŸ”§ ${agent} â†’ `, '') : title, detail, '');
      break;

    case 'tool_result':
      // Append result to the current tool block
      addToolCall(agent, title.replace('ğŸ“ ', '').replace(' returned', ''), '', detail);
      break;

    default:
      // Unknown category â€” show as detail
      addDetail(agent, title, detail);
  }
}

// â”€â”€ Update header status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHeader(data) {
  const phase = data.phase || 'idle';
  badge.textContent = phase.toUpperCase();
  badge.className = 'badge ' + (
    phase === 'idle' ? 'badge-idle' :
    phase === 'complete' ? 'badge-done' :
    phase === 'stopped' ? 'badge-error' : 'badge-active'
  );
  if (data.completed !== undefined) {
    progressText.textContent = `${data.completed}/${data.total || '?'} items Â· ${data.branch || ''}`;
  } else if (data.progress) {
    progressText.textContent = data.progress;
  }
}

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ws;
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}/ws`);
  ws.onopen = () => {};
  ws.onclose = () => setTimeout(connectWS, 3000);
  ws.onerror = () => {};
  ws.onmessage = (e) => {
    try {
      const msg = JSON.parse(e.data);
      console.log('WS event:', msg);
      if (msg.type === 'event') handleEvent(msg.data);
      else if (msg.type === 'status') updateHeader(msg.data);
      else if (msg.type === 'error') addStatus(`âŒ ${msg.data.message}`, 'status-error');
      else if (msg.type === 'ack') addStatus(`âœ“ ${msg.data}`);
    } catch (err) { console.warn('WS parse error:', err, e.data); }
  };
}

function sendTask() {
  const task = input.value.trim();
  if (!task) return;
  addUser(task);
  input.value = '';
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'task', task }));
  } else {
    fetch('/api/task', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ task }) })
      .then(r => r.json()).then(d => addStatus(`âœ“ Task queued`))
      .catch(e => addStatus(`âŒ Failed: ${e}`, 'status-error'));
  }
}


// â”€â”€ Intelligence Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _intelVisible = false;

function toggleIntel() {
  _intelVisible = !_intelVisible;
  const panel = document.getElementById('intelPanel');
  const btn   = document.getElementById('intelBtn');
  panel.style.display = _intelVisible ? 'flex' : 'none';
  btn.classList.toggle('active', _intelVisible);
  if (_intelVisible) loadIntelligence();
}

async function loadIntelligence() {
  const body = document.getElementById('intelBody');
  const cacheBadge = document.getElementById('intelCacheBadge');
  body.innerHTML = '<div class="intel-loading">Loadingâ€¦</div>';

  try {
    const [summary, smells, depGraph] = await Promise.all([
      fetch('/api/intelligence-summary').then(r => r.json()),
      fetch('/api/code-smells').then(r => r.json()),
      fetch('/api/dependency-graph').then(r => r.json()),
    ]);

    if (!summary.available) {
      body.innerHTML = '<div class="intel-empty">No intelligence data available yet.<br>Start a task to analyse the repository.</div>';
      cacheBadge.textContent = '';
      return;
    }

    cacheBadge.textContent = summary.cached ? `CACHED @ ${summary.cache_key || '?'}` : 'LIVE';

    const sections = [];

    // â”€â”€ Overview cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const staticErr  = summary.static?.errors  || 0;
    const staticWarn = summary.static?.warnings || 0;
    const smellErr   = summary.smells?.errors   || 0;
    const smellWarn  = summary.smells?.warnings || 0;
    const cycles     = summary.dependency_graph?.cycles || 0;
    const funcs      = summary.call_graph?.functions || 0;

    sections.push(`
      <div class="intel-section">
        <div class="intel-section-hdr" onclick="toggleSection(this)">
          <span class="s-icon">ğŸ“Š</span><span class="s-title">Overview</span>
        </div>
        <div class="intel-section-body">
          <div class="intel-cards">
            <div class="intel-card ${staticErr > 0 ? 'c-err' : 'c-ok'}">
              <div class="c-label">Static Errors</div>
              <div class="c-value">${staticErr}</div>
              <div class="c-sub">${staticWarn} warning(s)</div>
            </div>
            <div class="intel-card ${smellErr > 0 ? 'c-err' : smellWarn > 0 ? 'c-warn' : 'c-ok'}">
              <div class="c-label">Code Smells</div>
              <div class="c-value">${summary.smells?.total || 0}</div>
              <div class="c-sub">${smellErr} error(s), ${smellWarn} warning(s)</div>
            </div>
            <div class="intel-card ${cycles > 0 ? 'c-err' : 'c-ok'}">
              <div class="c-label">Dep Cycles</div>
              <div class="c-value">${cycles}</div>
              <div class="c-sub">${summary.dependency_graph?.modules || 0} modules</div>
            </div>
            <div class="intel-card c-info">
              <div class="c-label">Functions</div>
              <div class="c-value">${funcs}</div>
              <div class="c-sub">${summary.call_graph?.edges || 0} call edges</div>
            </div>
          </div>
        </div>
      </div>`);

    // â”€â”€ Circular imports â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const cycleList = depGraph.cycles || [];
    if (cycleList.length > 0) {
      const rows = cycleList.slice(0, 10).map(cycle =>
        `<div class="cycle-path">â­® ${esc(cycle.join(' â†’ '))} â†’ ${esc(cycle[0])}</div>`
      ).join('');
      const more = cycleList.length > 10
        ? `<div class="cycle-path" style="color:var(--text-dim)">â€¦ and ${cycleList.length - 10} more</div>` : '';
      sections.push(`
        <div class="intel-section">
          <div class="intel-section-hdr" onclick="toggleSection(this)">
            <span class="s-icon">â­®</span><span class="s-title">Circular Imports</span>
            <span class="s-count s-count-error">${cycleList.length}</span>
          </div>
          <div class="intel-section-body">${rows}${more}</div>
        </div>`);
    }

    // â”€â”€ Most-coupled modules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const depJson = depGraph.json || {};
    const couplingScores = depJson.coupling_scores || {};
    const topCoupled = Object.entries(couplingScores)
      .sort((a, b) => b[1] - a[1]).slice(0, 8);
    if (topCoupled.length > 0) {
      const rows = topCoupled.map(([mod, score]) => {
        const pct = Math.round(score * 100);
        return `
          <div class="coupling-row">
            <span style="flex:1;color:var(--text);font-size:11px;word-break:break-all">${esc(mod)}</span>
            <div class="coupling-bar-bg"><div class="coupling-bar" style="width:${pct}%"></div></div>
            <span class="coupling-score">${pct}%</span>
          </div>`;
      }).join('');
      sections.push(`
        <div class="intel-section">
          <div class="intel-section-hdr" onclick="toggleSection(this)">
            <span class="s-icon">ğŸ”—</span><span class="s-title">Most Coupled Modules</span>
          </div>
          <div class="intel-section-body">${rows}</div>
        </div>`);
    }

    // â”€â”€ Code smells â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const allSmells = smells.smells || [];
    if (allSmells.length > 0) {
      const shown = allSmells.slice(0, 20);
      const rows = shown.map(s => {
        const sevClass = s.severity === 'error' ? 'r-sev-error'
                       : s.severity === 'warning' ? 'r-sev-warning' : 'r-sev-info';
        return `
          <div class="intel-row">
            <span class="r-sev ${sevClass}">${s.severity.toUpperCase()}</span>
            <span class="r-text">
              <strong>${esc(s.smell_type)}</strong> â€” ${esc(s.description)}
              ${s.suggestion ? `<br><span style="color:var(--text-dim);font-size:10.5px">ğŸ’¡ ${esc(s.suggestion)}</span>` : ''}
            </span>
            <span class="r-loc">${esc(s.file)}:${s.line}</span>
          </div>`;
      }).join('');
      const more = allSmells.length > 20
        ? `<div class="intel-row" style="color:var(--text-faint)">â€¦ and ${allSmells.length - 20} more</div>` : '';
      const errCount  = smells.errors   || 0;
      const warnCount = smells.warnings || 0;
      const countClass = errCount > 0 ? 's-count-error' : warnCount > 0 ? 's-count-warning' : 's-count-ok';
      sections.push(`
        <div class="intel-section">
          <div class="intel-section-hdr" onclick="toggleSection(this)">
            <span class="s-icon">ğŸ”</span><span class="s-title">Code Smells</span>
            <span class="s-count ${countClass}">${allSmells.length}</span>
          </div>
          <div class="intel-section-body">${rows}${more}</div>
        </div>`);
    }

    body.innerHTML = sections.join('') || '<div class="intel-empty">All clear â€” no issues detected.</div>';

  } catch (err) {
    body.innerHTML = `<div class="intel-empty">Failed to load intelligence data.<br><small style="color:var(--text-faint)">${esc(String(err))}</small></div>`;
    console.error('intel load error:', err);
  }
}

function toggleSection(hdr) {
  hdr.closest('.intel-section').classList.toggle('collapsed');
}

// Auto-refresh intel panel on intelligence_complete event
function _onIntelligenceComplete() {
  if (_intelVisible) loadIntelligence();
  // Flash the button to signal new data
  const btn = document.getElementById('intelBtn');
  btn.style.background = 'var(--green-dim)';
  btn.style.color = 'var(--green)';
  setTimeout(() => {
    btn.style.background = '';
    btn.style.color = '';
  }, 2000);
}

input.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendTask(); });
connectWS();

// On page load, check if a task is already waiting for approval or a coder answer
fetch('/api/status').then(r => r.json()).then(data => {
  updateHeader(data);
  if (data.phase === 'waiting_for_approval' && !_approvalPanel) {
    fetch('/api/pending').then(r => r.json()).then(p => {
      if (p && p.needs_human_approval) showApprovalPanel(p.pending_approval || {});
    }).catch(() => {});
  }
  if (data.phase === 'waiting_for_answer' && !_questionPanel) {
    fetch('/api/question').then(r => r.json()).then(q => {
      if (q && q.needs_coder_answer) showQuestionPanel(q.coder_question || {});
    }).catch(() => {});
  }
}).catch(() => {});

setInterval(() => {
  if (!ws || ws.readyState !== WebSocket.OPEN) {
    fetch('/api/status').then(r => r.json()).then(updateHeader).catch(() => {});
  }
}, 5000);
</script>
</body>
</html>
